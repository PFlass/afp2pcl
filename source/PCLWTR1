//FLASSU   JOB (),PCLWTR1,CLASS=J,MSGCLASS=Z,                           00010000
//            REGION=2048K,NOTIFY=$                                     00020000
//ASM      EXEC PGM=ASMA90,                                             00030000
//        PARM='OBJECT,NODECK,ALIGN,RENT'                               00040000
//********************************************************************  00050000
//**       ASSEMBLE PROGRAM                                          *  00060000
//********************************************************************  00070000
//SYSLIB   DD DSN=FLASS.PCL.SOURCE,DISP=SHR                             00080000
//         DD DSN=SYSTEMS.MACLIB,DISP=SHR                               00090000
//         DD DSN=FLASS.PF.ASM,DISP=SHR                                 00100000
//         DD DSN=SYS1.MACLIB,DISP=SHR                                  00110000
//         DD DSN=CEE.SCEEMAC,DISP=SHR <=== Temporary?                  00120009
//         DD DSN=SYS1.MODGEN,DISP=SHR                                  00130000
//SYSPRINT DD SYSOUT=X,CHARS=(GT12)                                     00140000
//SYSUT1   DD UNIT=VIO,SPACE=(CYL,(1,1))                                00150000
//SYSUT2   DD UNIT=VIO,SPACE=(CYL,(1,1))                                00160000
//SYSUT3   DD UNIT=VIO,SPACE=(CYL,(1,1))                                00170000
//SYSLIN   DD DSN=&&ASM,UNIT=VIO,DISP=(,PASS),                          00180000
//            SPACE=(TRK,(3,3)),DCB=BLKSIZE=400                         00190000
//SYSIN    DD *                                                         00200000
         TITLE 'PCLWTR1 - LBD External Writer - subtask'                00210000
PCLWTR1  CSECT                                                          00220000
*********************************************************************** 00230000
*                                                                     * 00240000
* Module name: PCLWTR1                                                * 00250000
*                                                                     * 00260000
* Function:    LBD External Writer for AFP to PCL conversion.         * 00270000
*                                                                     * 00280000
* Author:      Peter Flass - NYS Legislative Bill Drafting Commission * 00290000
*              April, 1997.                                           * 00300000
*                                                                     * 00310000
* Operation:   Module mimics standard OS External Writer (IASXWR00).  * 00320000
*              AFP data in queue with writer name 'PCL' is read,      * 00330000
*              converted to PCL by "AFP2PCL", and replaced in the     * 00340000
*              spool queued to the designated printer.                * 00350000
*                                                                     * 00360000
* Attributes:  AMODE 31, RMODE ANY                                    * 00370000
*              Must be authorized to execute subsystem request.       * 00380000
*                                                                     * 00390000
* Status:      MVS/ESA/JES2 5.1                                       * 00400000
*                                                                     * 00410000
* Modifications:                                                      * 00420000
*              02-01-15   Form=STD for RMT6                        PRF* 00430043
*              01-07-30   Additional FREEPOOLs                     PRF* 00440043
*              00-12-01   Default meta class P->E                  PRF* 00450043
*              00-11-27   'X4135' or 'U93' == LOCAL                PRF* 00460043
*              00-05-18   SYSOUT class override for META           PRF* 00470043
*              00-01-14   Post Script redux (LRECL=260)            PRF* 00480037
*              99-06-18   'FREEPOOL' after close                   PRF* 00490032
*              99-03-12   Post Script processor                    PRF* 00500032
*              99-01-27/9 Write type 6 SMF record.                 PRF* 00510032
*              99-01-20 - New font lists for Assembly              PRF* 00520032
*              98-10-26 - Add Metacode write routine               PRF* 00530032
*              98-02-04 - Add WTO routine, fixes for PCLTEST       PRF* 00540013
*              98-03-11 - SEGLIB read routine                      PRF* 00550013
*              98-03-04 - Fix storage allocation problem           PRF* 00560013
*              98-02-05 - OUTGRP                                   PRF* 00570013
*              97-10-07 - Message improvements                     PRF* 00580013
*                                                                     * 00590000
*********************************************************************** 00600000
         EJECT                                                          00610000
         REGS  ,                   Equate registers                     00620000
LINK     EQU   R10                 Internal link register               00630000
BASE     EQU   R11                 First base register                  00640000
BASE2    EQU   R12                 Second base register                 00650000
                                                                        00660000
PCLWTR1  AMODE 31                                                       00670000
PCLWTR1  RMODE ANY                                                      00680000
         SPACE 3                                                        00690000
*                                                                       00700000
*        Miscellaneous Equates                                          00710000
*                                                                       00720000
DEFPRT   EQU   C'E'                SYSOUT print class for linemode      00730000
DEFMET   EQU   C'E'                SYSOUT print class for Meta PF001201 00740041
DEFPUN   EQU   C'B'                SYSOUT punch class for PCL           00750000
*                                                                       00760000
         TITLE 'PCLWTR1 - LBD External Writer - Initialization'         00770000
*********************************************************************** 00780000
*        Initialization - set up information for writer task          * 00790000
*********************************************************************** 00800000
PCLWTR1  CSECT                                                          00810000
         B     START-*(,R15)       Skip over comment                    00820000
         DC    AL1(VERSIONL)       L'comment                            00830000
PCLWTR1  VERSION 2.0               Memory comment                       00840000
         PRINT NOGEN                                                    00850000
                                                                        00860000
         SPACE 2                                                        00870000
* ------------------------------- *                                     00880000
*        Chain saveareas          *                                     00890000
* ------------------------------- *                                     00900000
START    EQU   *                                                        00910000
         SAVE  (14,12)             Save caller's registers              00920000
         LR    BASE,R15            Load base registers                  00930000
         LA    BASE2,4095(,BASE)        .                               00940000
         LA    BASE2,1(,BASE2)          .                               00950000
         USING PCLWTR1,BASE,BASE2       .                               00960000
         LR    R2,R1               Save parm list address               00970000
         STORAGE OBTAIN,LENGTH=WRKLEN+4096,LOC=BELOW                    00980000
         ST    R1,8(,R13)          Chain saveareas                      00990000
         ST    R13,4(,R1)               .                               01000000
         LR    R13,R1                   .                               01010000
         USING WORK,R13                 .                               01020000
         USING AFP2PCL_PARM,A2P_PARM Addressability for parms           01030000
         USING SSOB,MYSSOB         Addressability for SSOB              01040000
         MVC   COMMENT(8),VERSION  Identify workarea for dumps          01050000
         L     R1,16              Load A(CVT)                  PF021098 01060000
         L     R1,0(,R1)               A(TCB words)            PF021098 01070000
         L     R1,0(,R1)               A(TCB)                  PF021098 01080000
         L     R1,12(,R1)              A(TIOT)                 PF021098 01090000
         MVC   WTRNAME,0(R1)      Move jobname                 PF021098 01100000
         LR    R1,R2               Restore parm list address            01110000
                                                                        01120000
         MVC   SYSPRINT,SYSPRNTD   Init. SYSPRINT DCB                   01130000
         MVC   FONTLIB,FONTLBD     Init. FONTLIB  DCB                   01140000
         MVC   WIDTAB,WIDTABD      Init. WIDTHS   DCB                   01150000
         MVC   SEGLIB,SEGLIBD      Init. SEGLIB   DCB          PF980311 01160000
         MVC   AFPIN,AFPIND        Initialize AFPIN DCB        PF033098 01170003
                                                                        01180000
         SPACE 2                                                        01190000
* ------------------------------- *                                     01200000
*        Initialize Parmarea      *                                     01210000
* ------------------------------- *                                     01220000
         MVC   A2P_ID,=CL8'A2P PARM' Move flag                          01230000
         XC    A2P_PARM(A2P_L),A2P_PARM Clear parms                     01240000
         MVI   A2P_DWNL,C'N'       Move download flag                   01250000
         LM    R1,R4,0(R1)         Pick up parameter addresses          01260000
*                                  . R1=A(Communications ECB)           01270000
*                                  . R2=A(Font table)                   01280000
*                                  . R3=A(Statistics)                   01290000
*                                  . R4=A(Printer list)                 01300000
         STM   R1,R3,A2P_ECBA      Store for AFP2PCL                    01310000
         ST    R4,PRINTER_TABLE    Save A(Printer table)                01320000
         ST    R1,WAITLIST         Store ECB address for myself         01330000
         STCK  TASKSTRT-TASKSTAT(R3) Store task start time              01340000
         L     R1,=A(PRNTRTN)      Load A(print routine)                01350000
         ST    R1,A2P_PRTA         . (save entry address)               01360000
         ST    R13,A2P_PRTA+4      . (save A(DSA) <PL/I convention>)    01370000
         L     R1,=A(READRTN)      A(read routine)                      01380000
         ST    R1,A2P_RDA          .                                    01390000
         ST    R13,A2P_RDA+4       .                                    01400000
         L     R1,=A(PNCHRTN)      A(punch routine)                     01410000
         ST    R1,A2P_PCHA         .                                    01420000
         ST    R13,A2P_PCHA+4      .                                    01430000
         L     R1,=A(METARTN)      A(metacode routine)         PF981026 01440008
         ST    R1,A2P_META         .                           PF981026 01450008
         ST    R13,A2P_META+4      .                           PF981026 01460008
         L     R1,=A(FONTRTN)      A(fontlib routine)                   01470000
         ST    R1,A2P_FNTA         .                                    01480000
         ST    R13,A2P_FNTA+4      .                                    01490000
         L     R1,=A(LOOKUP)       A(printer lookup)                    01500000
         ST    R1,A2P_SRCH         .                                    01510000
         ST    R13,A2P_SRCH+4      .                                    01520000
         L     R1,=A(WIDRTN)       A(width table read)         PF021098 01530000
         ST    R1,A2P_WID          .                           PF021098 01540000
         ST    R13,A2P_WID+4       .                           PF021098 01550000
         L     R1,=A(SEGRTN)       A(seglib read)              PF031198 01560000
         ST    R1,A2P_SEG          .                           PF031198 01570000
         ST    R13,A2P_SEG+4       .                           PF031198 01580000
         LA    R1,WRKLEN(,R13)     Point to DEVDEP storage     PF030498 01590000
         ST    R1,A2P_DEVD         Store address               PF030498 01600000
                                                                        01610000
         MVI   STATUS,X'00'        Zero status bytes                    01620000
         XC    STATUS1(2),STATUS1  .                                    01630000
         MVI   STATUS2,X'00'       .                                    01640000
         MVI   STATUS3,X'00'                                   PF980407 01650006
         CLC   =C'PCLTEST',WTRNAME Q/ Is this test writer?     PF980407 01660006
         BNE   *+8                 .. no                       PF980407 01670006
         OI    STATUS3,ST_TEST     .. yes, set indicator       PF980407 01680006
         XC    OLDJOBI,OLDJOBI     Clear Job ID                         01690000
                                                                        01700000
         SPACE 2                                                        01710000
* ------------------------------- *                                     01720000
*        Issue ESTAE macro        *                                     01730000
* ------------------------------- *                                     01740000
         MVC   MACAREA(ESTALEN),ESTAE                                   01750000
         ST    R13,STAEPARM        Save R13 for recovery                01760000
         LA    R2,STAEPARM         point to parameter list              01770000
         LA    R1,MACAREA               .                               01780000
* ===>   ESTAEX PARAM=(R2),MF=(E,(1)) Establish exit                    01790000
                                                                        01800000
         SPACE 2                                                        01810000
* ------------------------------- *                                     01820000
*        Init SMF6 record         *                                     01830000
* ------------------------------- *                                     01840000
         XC    SMF6,SMF6           Initialize SMF record                01850021
         MVC   SMF6FLAG,=CL4'SMF6' Move Eyecatcher                      01860000
                                                                        01870000
         SPACE 2                                                        01880000
* ------------------------------- *                                     01890000
*        Load processing program  *                                     01900000
* ------------------------------- *                                     01910000
         LOAD  EP=AFP2PCL2         Load the program                     01920000
         ST    R0,AFP2PCLA         Store entry address                  01930000
         SR    R0,R0               Store zero following                 01940000
         ST    R0,AFP2PCLA+4       .                                    01950000
         LOAD  EP=AFP2PCV          Load EP->Compile date and tiPF100697 01960000
         LR    R1,R0               Point to version info       PF100697 01970000
         MVC   XVERS,0(R1)         Save version information    PF100697 01980000
         DELETE EP=AFP2PCV         Delete alternate EP         PF100697 01990000
                                                                        02000000
* ------------------------------- *                                     02010000
*        Build SSOB               *                                     02020000
* ------------------------------- *                                     02030000
         LA    R1,MYSSOB                                                02040000
         ST    R1,SSPARM                .                               02050000
         OI    SSPARM,X'80'             .                               02060000
         XC    MYSSOB,MYSSOB       Initialize SSOB                      02070000
         MVC   MYSSOB(WTRSOSIZ),WTRSSOB .                               02080000
         LA    R1,SSOBGN                .                               02090000
         ST    R1,SSOBINDV              .                               02100000
         LA    R1,SSSOSIZE              .                               02110000
         STH   R1,SSSOLEN               .                               02120000
         OI    SSSOFLG1,SSSOSPGM   Select by program                    02130000
         OI    SSSOFLG2,SSSOPSEE   PSO Extension present                02140000
         MVI   SSSOVER,SSSOCVER    Move version number                  02150000
         MVC   SSSOPGMN,WTRNAME    Init writer name            PF021098 02160000
         MVC   SSSOCLSL,BLANKS                                          02170000
         OI    SSSOFLGA,SSSOWTRN   Indicate External Writer             02180000
                                                                        02190000
         SPACE 2                                                        02200000
* ------------------------------- *                                     02210000
*        Init SVC99 parms         *                                     02220000
* ------------------------------- *                                     02230000
         MVC   DYNCMNT,=CL8'DYNALLOC' Move comment                      02240000
         XC    S99RBD,S99RBD       Relocate ADCONS in DYNALLOC parms    02250000
         LA    R1,S99RBD                     .                          02260000
         ST    R1,S99RBA                     .                          02270000
         OI    S99RBA,X'80'                  .                          02280000
         MVI   S99RBLN-S99RB+S99RBD,L'S99RBD .                          02290000
         MVC   S99T(256),S99LISTD                 .                     02300000
         MVC   S99T+256(S99LSTDL-256),S99LISTD+256                      02310000
         LA    R2,S99T             Point to list of addresses           02320000
         LR    R3,R2               Load relocation factor               02330000
RELOCATE EQU   *                   Relocate address list                02340000
         CLI   0(R2),X'FF'         Q/ End of list?                      02350000
         BE    RELOCEND            .. Yes, end loop                     02360000
         L     R0,0(R2)            Load list entry                      02370000
         ALR   R0,R3               Add relocation factor                02380000
         ST    R0,0(R2)            Re-store list entry                  02390000
         LA    R2,4(,R2)           Bump to next entry                   02400000
         B     RELOCATE            Go process                           02410000
RELOCEND EQU   *                   End relocate loop                    02420000
                                                                        02430000
         SPACE 2                                                        02440000
* ------------------------------- *                                     02450000
*        Allocate message dataset *                                     02460000
* ------------------------------- *                                     02470000
         BAL   LINK,ALLOCP         Allocate message dataset             02480000
         LA    R1,S99DDN5-S99LISTD+S99T Load A(assigned DDname)         02490000
         MVC   DCBDDNAM-IHADCB+SYSPRINT(L'DCBDDNAM),0(R1) Move DDname   02500000
         MVC   PRTDD,0(R1)                                              02510000
                                                                        02520000
         MVC   MACAREA(OPENDL),OPEND Move open list skeleton            02530000
         LA    R1,MACAREA          Open 'SYSPRINT' DCB                  02540000
         LA    R2,SYSPRINT         .                                    02550000
         OPEN  ((R2),OUTPUT),MF=(E,(1)),MODE=31 .                       02560000
         LA    R15,DCBDDNAM-IHADCB+SYSPRINT Point to DDname             02570000
         TM    DCBOFLGS-IHADCB+SYSPRINT,DCBOFOPN Q/ Open successful?    02580000
         BNO   BLDEM6              .. No                                02590000
         OI    STATUS1,ST_MSOPN    .. Yes, indicate opened              02600000
         MVC   WTOAREA(M12L),M12   Print 'version' message     PF030698 02610003
         MVC   M12VERS-M12+WTOAREA(18),XVERS                   PF030698 02620003
         BAL   LINK,MSGRTN         Display message             PF030698 02630003
                                                                        02640000
         SPACE 2                                                        02650000
* ------------------------------- *                                     02660000
*        Open FONTLIB             *                                     02670000
* ------------------------------- *                                     02680000
         MVC   MACAREA(OPENDL),OPEND Move open list skeleton            02690000
         LA    R1,MACAREA          Open 'FONTLIB' DCB                   02700000
         LA    R2,FONTLIB          .                                    02710000
         OPEN  ((R2),INPUT),MF=(E,(1)),MODE=31 .                        02720000
         LA    R15,DCBDDNAM-IHADCB+FONTLIB  Point to DDname             02730000
         TM    DCBOFLGS-IHADCB+FONTLIB,DCBOFOPN Q/ Open successful?     02740000
         BNO   BLDEM6              .. No                                02750000
         OI    STATUS1,ST_FTOPN    .. Yes, indicate opened              02760000
         CLC   DCBLRECL-IHADCB+FONTLIB,=AL2(80) Q/ LRECL=80?            02770000
         BNE   BLDEM2              .. no, error                         02780000
         TM    DCBRECFM-IHADCB+FONTLIB,DCBRECU Check RECFM=F(B)         02790000
         BO    BLDEM2              .                                    02800000
         TM    DCBRECFM-IHADCB+FONTLIB,DCBRECF                          02810000
         BNO   BLDEM2                                                   02820000
         LH    R0,DCBBLKSI-IHADCB+FONTLIB Load BLKSIZE                  02830000
         ST    R0,FNTBUFL          Save it                              02840000
         STORAGE OBTAIN,LENGTH=(0),LOC=ANY Get a buffer                 02850000
         LA    R1,0(,R1)           clear bit0                           02860000
         ST    R1,FNTBUF           Store buffer address                 02870000
         ST    R1,FNTBUFP          Set buffer pointer                   02880000
         A     R1,FNTBUFL          Point to end of buffer               02890000
         ST    R1,FNTBUFE          Save end-of-buffer address           02900000
         OI    STATUS,ST_FTBFF     Indicate buffer acquired             02910000
                                                                        02920000
         SPACE 2                                                        02930000
* ------------------------------- *                                     02940000
*        Open WIDTAB              *                                     02950000
* ------------------------------- *                                     02960000
         MVC   MACAREA(OPENDL),OPEND Move open list skeleton            02970000
         LA    R1,MACAREA          Open 'WIDTAB' DCB                    02980000
         LA    R2,WIDTAB           .                                    02990000
         OPEN  ((R2),INPUT),MF=(E,(1)),MODE=31 .                        03000000
         LA    R15,DCBDDNAM-IHADCB+WIDTAB   Point to DDname             03010000
         TM    DCBOFLGS-IHADCB+WIDTAB,DCBOFOPN Q/ Open successful?      03020000
         BNO   BLDEM6              .. No                                03030000
         OI    STATUS1+1,ST_WTOPN  .. Yes, indicate opened              03040000
         TM    DCBRECFM-IHADCB+WIDTAB,DCBRECU Check RECFM=VB            03050000
         BO    BLDEM2                                                   03060000
         TM    DCBRECFM-IHADCB+WIDTAB,DCBRECV                           03070000
         BNO   BLDEM2                                                   03080000
         LH    R0,DCBBLKSI-IHADCB+WIDTAB Load BLKSIZE                   03090000
         ST    R0,WIDBUFL          Save it                              03100000
         STORAGE OBTAIN,LENGTH=(0),LOC=ANY Get a buffer                 03110000
         LA    R1,0(,R1)           clear bit0                           03120000
         ST    R1,WIDBUF           Store buffer address                 03130000
         ST    R1,WIDBUFP          Set buffer pointer                   03140000
         A     R1,WIDBUFL          Point to end of buffer               03150000
         ST    R1,WIDBUFE          Save end-of-buffer address           03160000
         OI    STATUS,ST_WTBFF     Indicate buffer acquired             03170000
                                                                        03180000
         SPACE 2                                                        03190000
* ------------------------------- *                                     03200000
*        Open SEGLIB              *                                     03210000
* ------------------------------- *                                     03220000
         MVC   MACAREA(OPENDL),OPEND Move open list skeleton            03230000
         LA    R1,MACAREA          Open 'SEGLIB' DCB                    03240000
         LA    R2,SEGLIB           .                                    03250000
         OPEN  ((R2),INPUT),MF=(E,(1)),MODE=31 .                        03260000
         LA    R15,DCBDDNAM-IHADCB+SEGLIB   Point to DDname             03270000
         TM    DCBOFLGS-IHADCB+SEGLIB,DCBOFOPN Q/ Open successful?      03280000
         BNO   BLDEM6              .. No                                03290000
         OI    STATUS1+1,ST_SGOPN  .. Yes, indicate opened     PF980313 03300000
         TM    DCBRECFM-IHADCB+SEGLIB,DCBRECU Check RECFM=VB            03310000
         BO    BLDEM2                                                   03320000
         TM    DCBRECFM-IHADCB+SEGLIB,DCBRECV                           03330000
         BNO   BLDEM2                                                   03340000
         LH    R0,DCBBLKSI-IHADCB+SEGLIB Load BLKSIZE                   03350000
         ST    R0,SEGBUFL          Save it                              03360000
         STORAGE OBTAIN,LENGTH=(0),LOC=ANY Get a buffer                 03370000
         LA    R1,0(,R1)           clear bit0                           03380000
         ST    R1,SEGBUF           Store buffer address                 03390000
         ST    R1,SEGBUFP          Set buffer pointer                   03400000
         A     R1,SEGBUFL          Point to end of buffer               03410000
         ST    R1,SEGBUFE          Save end-of-buffer address           03420000
         OI    STATUS,ST_SGBFF     Indicate buffer acquired             03430000
                                                                        03440000
         SPACE 2                                                        03450000
* ------------------------------- *                                     03460000
*        Init LE modules          *                                     03470000
* ------------------------------- *                                     03480000
         LOAD  EP=CEEPIPI          Load pre-initialization interface    03490000
         ST    R0,PIPIADDR         Save address                         03500000
         MVI   RTOPT,C' '          Init run-time options                03510000
         MVC   RTOPT+1(L'RTOPT-1),RTOPT                                 03520000
         TM    STATUS3,ST_TEST     Q/ Test writer?             PF980407 03530006
         BNO   ISPROD              .. no                       PF980407 03540006
ISTEST   MVC   RTOPT(TOPTL),TOPT   .                           PF980407 03550006
         B     INITPIPI                                        PF980407 03560006
ISPROD   MVC   RTOPT(POPTL),POPT   .                           PF980407 03570006
*                                  Initialize PIPI parameter list       03580000
INITPIPI EQU   *                   .                           PF980407 03590006
         LA    R1,INITSUB          . A(Function)                        03600000
         ST    R1,PARMLIST         .                                    03610000
         LA    R1,APIPITAB         . A(PIPITAB)                         03620000
         ST    R1,PARMLIST+4       .                                    03630000
         LA    R1,AZERO            . A(Service Routines=0)              03640000
         ST    R1,PARMLIST+8       .                                    03650000
         LA    R1,RTOPT            . A(Run Time Options)                03660000
         ST    R1,PARMLIST+12      .                                    03670000
         LA    R1,TOKEN            . A(Token)                           03680000
         ST    R1,PARMLIST+16      . (don't set HOB)                    03690000
         LA    R1,PARMLIST         Call CEEPIPI                         03700000
         L     R15,PIPIADDR        .                                    03710000
         BASSM R14,R15             .                                    03720000
         LTR   R15,R15             Test return code                     03730000
         BNZ   BLDEM4              .. error                             03740000
                                                                        03750000
         SPACE 2                                                        03760000
* ------------------------------- *                                     03770000
*        Indicate 'ACTIVE'        *                                     03780000
* ------------------------------- *                                     03790000
         MVC   WTOAREA(M11L),M11   Move 'active' message       PF040398 03800002
         BAL   LINK,MSGRTN         Display message             PF040398 03810002
                                                                        03820000
                                                                        03830000
INITEND  EQU   *                   End of initialization code           03840000
                                                                        03850000
         TITLE 'PCLWTR1 - LBD External Writer - Mainline'               03860000
*********************************************************************** 03870000
*        Mainline loop - wait for work or cancel request              * 03880000
*********************************************************************** 03890000
HASPREQ  DS    0H                  Subsystem request                    03900000
                                                                        03910000
*------- Execute subsystem request in supervisor state ----------*    * 03920000
         MODESET MODE=SUP          Enter Supervisor State        |    * 03930000
         LA    R1,SSPARM           Load A(SSOB Address)          |    * 03940000
         IEFSSREQ                  Ask JES for work              |    * 03950000
         LR    R2,R15              Save return code              |    * 03960000
         MODESET MODE=PROB         Leave Supervisor State        |    * 03970000
         LR    R15,R2              Restore return code           |    * 03980000
*------- End of supervisor state code ---------------------------*    * 03990000
                                                                        04000000
* ------------------------------- *                                     04010000
*        Test JES return code     *                                     04020000
* ------------------------------- *                                     04030000
         LTR   R15,R15             Test return code                     04040000
         BNZ   BLDEM1              .. Error, go write message           04050000
         CLI   SSOBRETN+3,SSSORTOK Q/ RC=0?                             04060000
         BE    PROCDS              .. Process next dataset              04070000
         MVI   SSSODSN,0           Reset for initial request            04080000
         MVC   SSSODSN+1(L'SSSODSN-1),SSSODSN                           04090000
         CLI   SSOBRETN+3,SSSOEODS Q/ No more datasets?                 04100000
         BNE   BLDEM7              .. No, logic error                   04110000
         TM    SSSOFLG2,SSSOCTRL   Q/ Last req completed?               04120000
         BZ    HASPWAIT            .. Yes, wait for work or command     04130000
         NI    SSSOFLG2,255-SSSOCTRL Reset for init cmd                 04140000
         BAL   LINK,WRITESMF       Write previous SMF 6 record if any   04150000
                                                                        04160000
* ------------------------------- *                                     04170000
*        Wait for work            *                                     04180000
* ------------------------------- *                                     04190000
HASPWAIT EQU   *                    Wait for work                       04200000
         L     R1,SSSOWTRC          Get A(JES ECB)                      04210000
         ST    R1,WAITLIST+4       Save into WAITLIST                   04220000
         OI    WAITLIST+4,X'80'    Mark it end of list                  04230000
                                                                        04240000
*------- Execute wait request in supervisor state, key 0 --------*    * 04250000
         MODESET MODE=SUP,KEY=ZERO Enter Supervisor State, Key 0 |    * 04260000
         LA    R1,WAITLIST                                       |    * 04270000
         WAIT  ECBLIST=(1)                                       |    * 04280000
         MODESET MODE=PROB,KEY=NZERO Leave Supervisor State      |    * 04290000
*------- End of supervisor state code ---------------------------*    * 04300000
                                                                        04310000
         L     R1,WAITLIST         Get A(communications ECB)            04320000
         TM    ECBCC-ECB(R1),ECBPOST Q/ Comm ECB posted?                04330000
         BNO   HASPREQ             .. No, Go get work to do             04340000
*        Stop or drain is all the same at this point                    04350000
         B     EXIT                .. Yes, STOP in progress             04360000
                                                                        04370000
         TITLE 'PCLWTR1 - Process one dataset'                          04380000
*********************************************************************** 04390000
*        Process one dataset                                          * 04400000
*********************************************************************** 04410000
PROCDS   DS    0H                  Process one dataset                  04420000
         MVI   A2P_FLAG,x'00'      Clear Option Flags          20050606 04421047
         MVC   PCLOUT,PCLOUTD      Init. PCLOUT   DCB                   04430000
         MVI   STATUS2,X'00'       Zero linemode flag                   04440000
         MVI   S99CLS3-S99LISTD+S99T,DEFPUN Move default SYSOUT class   04450008
         MVI   A2P_CLAS,DEFPUN                                 PF000518 04460036
         CLC   =C'R6 ',SSSODEST    Q/ 4235?                    *DEBUG*  04470012
         BNE   X423501             .. no                       *DEBUG*  04480012
         MVC   SSSODEST,=C'METACODE' .. yes                    *DEBUG*  04490012
         OI    STATUS2,ST_META     .. yes, set 'Metacode' flag *DEBUG*  04500012
         MVI   S99CLS3-S99LISTD+S99T,DEFMET Move SYSOUT Class  *DEBUG*  04510012
         MVI   A2P_CLAS,DEFMET                                 PF000518 04520036
         MVC   PCLOUT,METAOUTD     Init. METAOUT  DCB          *DEBUG*  04530012
         B     PROCDS05                                        *DEBUG*  04540012
X423501  EQU   *                                               *DEBUG*  04550012
         CLC   =C'U93  ',SSSODEST  Q/ Dest='X4135'?            PF001127 04560039
         BE    X423502             .. yes, metacode            PF001127 04570039
         CLC   =C'LOCAL',SSSODEST  Q/ Dest='LOCAL'?            PF981026 04580038
         BNE   PROCDS02            .. no, not metacode         PF981026 04590038
X423502  EQU   *                                               PF001127 04600038
         OI    STATUS2,ST_META     .. yes, set 'Metacode' flag PF981026 04610038
         MVI   S99CLS3-S99LISTD+S99T,DEFMET Move SYSOUT Class  PF981026 04620038
         MVI   A2P_CLAS,DEFMET                                 PF000518 04630038
         MVC   PCLOUT,METAOUTD     Init. METAOUT  DCB          PF981026 04640038
         B     PROCDS05                                        PF981026 04650038
PROCDS02 EQU   *                                               PF981026 04660008
         CLC   =F'0',SSSOLNCT      Q/ Is line count zero?               04670000
         BE    PROCDS05            .. yes, must be page mode            04680000
         OI    STATUS2,ST_LINE     .. no, indicate line mode            04690000
PROCDS05 EQU   *                                                        04700000
         CLC   SSSOJOBN,SMF6JBN-SMFRCD6+SMF6 Q/ Name chg?               04710000
         BNE   PROCDS10            .. Yes, start new job                04720000
         CLC   SSSOJOBI,OLDJOBI Q/ Did job id change?                   04730000
         BE    PROCDS20            .. No, same job                      04740000
PROCDS10 EQU   *                   New Job                              04750000
         BAL   LINK,WRITESMF       Write previous SMF record if any     04760000
         MVC   OLDJOBI,SSSOJOBI    Save new job id                      04770000
         L     R1,A2P_STAT         Load A(statistics area)              04780000
@STAT    USING TASKSTAT,R1                                              04790000
         STCK  @STAT.TASKJBST      Save job start time                  04800000
         L     R15,@STAT.TASKJBSP  Load Job count                       04810000
         LA    R15,1(,R15)         Bump count                           04820000
         ST    R15,@STAT.TASKJBSP  Save Job count                       04830000
         MVC   @STAT.TASKJBNI,OLDJOBI   Save job ID                     04840000
         MVC   @STAT.TASKJBNM,SSSOJOBN  Save job name                   04850000
         XC    @STAT.TASKPGSP,@STAT.TASKPGSP       Zero page count      04860000
         XC    @STAT.TASKCRDS,@STAT.TASKCRDS       Zero output count    04870000
         MVC   DEST,SSSODEST Save job destination                       04880000
                                                                        04890000
*       * ---------------------------- *                                04900000
*       *  Format 'jobname(jobid),'    *                                04910000
*       * ---------------------------- *                                04920000
         MVI   JOBID_SAVE,C' '     Build 'jobname(jobid),' for msgs     04930000
         MVC   JOBID_SAVE+1(L'JOBID_SAVE-1),JOBID_SAVE                  04940000
         MVC   JOBID_SAVE(8),SSSOJOBN                                   04950000
         LA    R1,JOBID_SAVE                                            04960000
PROCDS15 EQU   *                                                        04970000
         LA    R1,1(,R1)                                                04980000
         CLI   0(R1),C' '                                               04990000
         BNE   PROCDS15                                                 05000000
         MVI   0(R1),C'('                                               05010000
         MVC   1(8,R1),SSSOJOBI                                         05020000
         MVI   9(R1),C')'                                               05030000
         MVI   10(R1),C','                                              05040000
         DROP  @STAT                                                    05050000
                                                                        05060000
         EJECT                                                          05070000
* ------------------------------- *                                     05080000
*        Allocate datasets        *                                     05090000
* ------------------------------- *                                     05100000
PROCDS20 EQU   *                                                        05110000
         MVC   A2P_DEST,DEST       Move JES destination to parms        05120000
         XC    A2P_RETC,A2P_RETC   Zero return code                     05130000
                                                                        05140000
*       *------------------------ *                                     05150000
*       *  AFP Input              *                                     05160000
*       *------------------------ *                                     05170000
         BAL   LINK,ALLOCIN        Allocate input dataset               05180000
         LA    R1,S99DDN1-S99LISTD+S99T Load A(assigned DDname)         05190000
         MVC   DCBDDNAM-IHADCB+AFPIN(L'DCBDDNAM),0(R1) Move DDname      05200000
         L     R0,=A(RDEOF)        Initialize EODAD            PF033198 05210000
         LA    R1,DCBEODA-IHADCB+AFPIN                         PF033198 05220000
         STCM  R0,B'0111',0(R1)    .                           PF033198 05230000
         LA    R1,JFCB             Set up exit list                     05240000
         ST    R1,EXLIST           .                                    05250000
         MVI   EXLIST,X'87'        .                                    05260000
         LA    R1,EXLIST           .                                    05270000
         STCM  R1,B'0111',DCBEXLSA-IHADCB+AFPIN                         05280000
         LA    R1,AFPIN            Read the JFCB                        05290000
         ST    R1,MACAREA          .                                    05300000
         MVI   MACAREA,X'80'       .                                    05310000
         LA    R1,MACAREA          .                                    05320000
         RDJFCB ,MF=(E,(1))        .                                    05330000
         TM    STATUS2,ST_META     Q/ Metacode input?          PF981026 05340008
         BO    LMSET00             .. yes, bypass PS test      PF981026 05350011
         CLC   JFCLRECL,=AL2(260)  Q/ Max LRECL=260?           PF000114 05360034
         BNE   *+8                 .. no, not DCF PostScript            05370000
         OI    STATUS2,ST_PS       .. yes, indicate PostScript          05380000
LMSET00  EQU   *                                               PF981026 05390008
         MVC   MACAREA(OPENDL),OPEND Move open list skeleton            05400000
         LA    R1,MACAREA          Open 'AFPIN' DCB                     05410000
         LA    R2,AFPIN            .                                    05420000
         OPEN  ((R2),INPUT),MF=(E,(1)),MODE=31 .                        05430000
         LA    R15,DCBDDNAM-IHADCB+AFPIN    Point to DDname             05440000
         TM    DCBOFLGS-IHADCB+AFPIN,DCBOFOPN Q/ Open successful?       05450000
         BNO   BLDEM6              .. No                                05460000
         OI    STATUS1,ST_INOPN    .. Yes, indicate opened              05470000
         TM    STATUS2,ST_META     Q/ Metacode?                PF981026 05480008
         BO    PROCDS25            .. yes                      PF981026 05490008
         TM    STATUS2,ST_LINE     Q/ Line mode?                        05500008
         BNO   PROCDS25            .. no                                05510008
*       *-------------------------*                                     05520000
*       * Linemode setup          *                                     05530000
*       *-------------------------*                                     05540000
         LA    R0,LMCLOSE          Set up EODAD                         05550000
         LA    R1,DCBEODA-IHADCB+AFPIN                                  05560000
         STCM  R0,B'0111',0(R1)    .                                    05570000
         LA    R1,AFPIN            Complete Linemode tests              05580000
         GET   (1)                 .                                    05590000
         CLI   4(R1),X'5A'         Q/ Is this really AFP?               05600000
         BNE   LMSET01             .. no                                05610000
         NI    STATUS2,255-(ST_LINE+ST_PS)                              05620000
         B     LMCLOSE                                                  05630000
LMSET01  EQU   *                                                        05640000
         CLI   4(R1),X'25'         Q/ Is it really Postscript?          05650000
*                                  (x'25' = ASCII '%')         PF990311 05660026
         BE    LMCLOSE             .. yes                      PF990312 05670028
         NI    STATUS2,255-ST_PS   .. no, reset Post Script fl PF990312 05680028
         B     LMCLOSE                                                  05690000
LMCLOSE  EQU   *                                                        05700000
         LA    R1,MACAREA          Close 'AFPIN' DCB                    05710000
         LA    R2,AFPIN            .                                    05720000
         CLOSE ((R2)),MF=(E,(1)),MODE=31 .                              05730000
         FREEPOOL (R2)             Free the buffer pool        PF990618 05740032
         NI    STATUS1,255-ST_INOPN  Indicate closed                    05750000
         L     R0,=A(RDEOF)        Set up EODAD                PF033198 05760000
         LA    R1,DCBEODA-IHADCB+AFPIN                         PF033198 05770000
         STCM  R0,B'0111',0(R1)    .                           PF033198 05780000
         MVC   MACAREA(OPENDL),OPEND Move open list skeleton            05790000
         LA    R1,MACAREA          Re-Open 'AFPIN' DCB                  05800000
         LA    R2,AFPIN            .                                    05810000
         OPEN  ((R2),INPUT),MF=(E,(1)),MODE=31 .                        05820000
         LA    R15,DCBDDNAM-IHADCB+AFPIN    Point to DDname             05830000
         TM    DCBOFLGS-IHADCB+AFPIN,DCBOFOPN Q/ Open successful?       05840000
         BNO   BLDEM6              .. No                                05850000
         OI    STATUS1,ST_INOPN    .. Yes, indicate opened              05860000
         TM    STATUS2,ST_PS       Q/ Post Script              PF990312 05870029
         BO    PROCDS25            .. yes                      PF990312 05880029
         TM    STATUS2,ST_LINE     Q/ Line mode?                        05890000
         BNO   PROCDS25            .. no                                05900000
         TM    STATUS2,ST_PS       Q/ Post Script              PF990312 05910029
         BO    PROCDS25            .. yes                      PF990312 05920029
         LH    R0,JFCLRECL         Load max input LRECL                 05930000
         AH    R0,=H'4'            Add L'VRL to LRECL                   05940000
         STH   R0,DCBLRECL-IHADCB+PCLOUT Reset PCLOUT LRECL for line    05950000
         IC    R1,JFCRECFM               Get input  RECFM               05960000
         N     R1,=A(JFCCHAR)            Isolate CTLCHAR bits           05970000
         STC   R1,DCBRECFM-IHADCB+PCLOUT Save RECFM                     05980000
         OI    DCBRECFM-IHADCB+PCLOUT,DCBRECV+DCBRECBR set 'VAR BLK'    05990000
         MVC   S99CLS3-S99LISTD+S99T,SSSOCLAS Move print SYSOUT class   06000000
                                                                        06010000
*       *------------------------ *                                     06020000
*       *  PCL/META Output        *                                     06030008
*       *------------------------ *                                     06040000
PROCDS25 EQU   *                                                        06050000
         BAL   LINK,ALLOCOT        Allocate output dataset              06060000
         LA    R1,S99DDN3-S99LISTD+S99T Load A(assigned DDname)         06070000
         MVC   DCBDDNAM-IHADCB+PCLOUT(L'DCBDDNAM),0(R1) Move DDname     06080000
         MVC   MACAREA(OPENDL),OPEND Move open list skeleton            06090000
         LA    R1,MACAREA          Open 'PCLOUT' DCB                    06100000
         LA    R2,PCLOUT           .                                    06110000
         OPEN  ((R2),OUTPUT),MF=(E,(1)),MODE=31 .                       06120000
         LA    R15,DCBDDNAM-IHADCB+PCLOUT   Point to DDname             06130000
         TM    DCBOFLGS-IHADCB+PCLOUT,DCBOFOPN Q/ Open successful?      06140000
         BNO   BLDEM6              .. No                                06150000
         OI    STATUS1,ST_OTOPN    .. Yes, indicate opened              06160000
         EJECT                                                          06170000
                                                                        06180000
* ------------------------------- *                                     06190000
*        Printer lookup           *                                     06200000
* ------------------------------- *                                     06210000
         XC    A2P_PRTT,A2P_PRTT   Clear printer table pointer          06220000
         LA    R1,DEST                                                  06230000
         TM    STATUS2,ST_META     Q/ Metacode?                PF981028 06240012
         BNO   *+8                 .. nope                     PF981028 06250012
         LA    R1,=CL8'LOCAL'      .. yup, fudge printer id    PF981028 06260031
         ST    R1,DWD+4            .                                    06270000
         LA    R1,DWD+4            .                                    06280000
         ST    R1,DWD              .                                    06290000
         LA    R1,DWD              .                                    06300000
         L     R5,A2P_SRCH+4       .                                    06310000
         L     R15,A2P_SRCH        .                                    06320000
         BALR  R14,R15             .                                    06330000
         LTR   R15,R15             Q/ Did we find printer?              06340000
         BNZ   PROCDS30            .. yes, okay                         06350000
*       *------------------------ *                                     06360000
*       * Not a PCL Printer       *                                     06370000
*       *------------------------ *                                     06380000
BLDE320  EQU   *                   'Not a PCL printer'                  06390038
         MVC   WTOAREA(E320L),E320 Move message to build area           06400038
         MVC   E320PRT-E320+WTOAREA,DEST                       PF040398 06410038
         BAL   LINK,MSGRTN         Display message             PF040398 06420002
         MVI   A2P_RETC+3,16       Set return code                      06430000
         B     PROCDS90                                        PF980407 06440005
         SPACE 2                                                        06450000
                                                                        06460000
* ------------------------------- *                                     06470000
*        Display 'START' message  *                                     06480000
* ------------------------------- *                                     06490000
PROCDS30 EQU   *                                                        06500000
         MVC   WTOAREA(M8L),M8     Move 'start' message        PF040398 06510002
         MVC   M8JOB-M8+WTOAREA,JOBID_SAVE Move 'jobname(jobid),'040398 06520002
         L     R1,A2P_PRTT-AFP2PCL_PARM+A2P_PARM Move destination100697 06530000
         MVC   M8DEST-M8+WTOAREA,PRID-PRINTER(R1)              PF040398 06540002
         TM    STATUS2,ST_LINE     Q/ Linemode data?           PF100697 06550000
         BNO   PROCDS35            .. no                       PF100697 06560000
         MVC   M8TYP-M8+WTOAREA,=C'*LINE*'    .. yes, linemode PF040398 06570002
         TM    STATUS2,ST_PS       Q/ Postscript data?         PF100697 06580000
         BNO   PROCDS35            .. no                       PF100697 06590000
         MVC   M8TYP-M8+WTOAREA,=C'* PS *'    .. yes, ps       PF040398 06600002
PROCDS35 EQU   *                                               PF100697 06610000
         BAL   LINK,MSGRTN         Display message             PF040398 06620002
                                                                        06630000
         EJECT                                                          06640000
* ------------------------------- *                                     06650000
*        Process input dataset    *                                     06660000
* ------------------------------- *                                     06670000
         TM    STATUS2,ST_LINE     Q/ Linemode data?                    06680000
         BNO   PROCDS40            .. no                                06690000
         TM    STATUS2,ST_PS       Q/ PostScript data?         PF990312 06700027
         BNO   PROCDS37            .. no                       PF990312 06710027
         LA    R1,A2P_PARM         .. yes, process PS data     PF990312 06720027
         ST    R1,PARMLIST                                     PF990312 06730027
         OI    PARMLIST,X'80'                                  PF990312 06740027
         LA    R1,PARMLIST                                     PF990312 06750027
         L     R15,=V(PS)                                      PF990312 06760027
         BALR  R14,R15                                         PF990312 06770027
         B     PROCDS55            all done                    PF990315 06780030
PROCDS37 EQU   *                                               PF990312 06790027
         XC    A2P_RETC,A2P_RETC   .. yes, Clear return code            06800000
         BAL   LINK,LINEMODE       .. Process Linemode data             06810000
         B     PROCDS55            all done                    PF990315 06820030
                                                                        06830000
PROCDS40 EQU   *                                                        06840000
         L     R1,A2P_PRTT-AFP2PCL_PARM+A2P_PARM Move default tray      06850000
         MVC   A2P_TRAY,PRTRAY-PRINTER(R1)      .                       06860000
         XC    A2P_RETC,A2P_RETC   Clear return code                    06870000
         LA    R1,A2P_PARM         PTR->my_parameter_list               06880000
         ST    R1,PADDR            .                                    06890000
         LA    R1,PADDR            A(pointer variable)                  06900000
         ST    R1,APTR             .                                    06910000
         OI    APTR,X'80'          .                                    06920000
         LA    R1,APTR             A(parameter list)                    06930000
         ST    R1,AADDR            .                                    06940000
         OI    AADDR,X'80'         .                                    06950000
*                                  Initialize PIPI parameter list       06960000
         LA    R1,CALLSUBA         . A(Function)                        06970000
         ST    R1,PARMLIST         .                                    06980000
         LA    R1,AFP2PCLA         . A(entry point)                     06990000
         ST    R1,PARMLIST+4       .                                    07000000
         LA    R1,TOKEN            . A(Token)                           07010000
         ST    R1,PARMLIST+8       .                                    07020000
         LA    R1,AADDR            . A( parameter_list_address )        07030000
         ST    R1,PARMLIST+12      .                                    07040000
         LA    R1,RC               . A(Return code)                     07050000
         ST    R1,PARMLIST+16      .                                    07060000
         LA    R1,REAS             . A(Reason code)                     07070000
         ST    R1,PARMLIST+20      .                                    07080000
         LA    R1,FDBK             . A(Feedback code)                   07090000
         ST    R1,PARMLIST+24      . Don't set HOB                      07100000
         LA    R1,PARMLIST         Call CEEPIPI                         07110000
         L     R15,PIPIADDR        .                                    07120000
         BASSM R14,R15             .                                    07130000
         ST    R15,RC              Save return code                     07140000
                                                                        07150000
         EJECT                                                          07160000
* ------------------------------- *                                     07170000
*        Processing completed     *                                     07180000
* ------------------------------- *                                     07190000
PROCDS50 EQU   *                                                        07200000
         ICM   R2,B'1111',A2P_PRTT Load A(printer entry)       PF980406 07210004
         USING PRINTER,R2                                      PF980606 07220004
         BZ    ABEND               .. no printer               PF980406 07230004
         TM    PRFLGF,PRFLGFR      Test download flag          PF980406 07240004
         BNO   PROCDS55            .. not set                  PF980406 07250004
*        The following code moved                              PF990315 07260030
         OC    A2P_RETC,A2P_RETC   Test return code                     07270030
         BNZ   PROCDS55            skip if not zero                     07280030
*????????????????*                                                      07290030
* is this safe?  *                                                      07300030
*????????????????*                                                      07310030
         NI    PRFLGF,255-PRFLGFR  Reset download flag                  07320030
         MVC   WTOAREA(M14L),M14   Move 'downloaded' message   PF980406 07330030
         MVC   M14FS-M14+WTOAREA,PRFSET   Move fontset id      PF980406 07340030
         MVC   M14DEST-M14+WTOAREA,PRID   Move printer id      PF980406 07350030
         BAL   LINK,MSGRTN         Display message             PF040398 07360030
PROCDS55 EQU   *                                               PF980406 07370004
         MVC   WTOAREA(M9L),M9     Move 'end' message          PF040398 07380004
         MVC   M9JOB-M9+WTOAREA,JOBID_SAVE Move 'jobname(jobid),'040398 07390002
         L     R0,A2P_RETC         Move return code            PF100697 07400000
         CVD   R0,DWD              .                           PF100697 07410000
         UNPK  DWD(3),DWD+6(2)     .                           PF100697 07420000
         OI    DWD+2,C'0'          .                           PF100697 07430000
         MVC   M9RC-M9+WTOAREA,DWD+1 .                         PF040398 07440002
         BAL   LINK,MSGRTN         Display message             PF040398 07450002
PROCDS60 EQU   *                                                        07460000
         L     R1,A2P_STAT         Load A(statistics area)              07470000
@STAT    USING TASKSTAT,R1                                              07480000
PROCDS61 EQU   *                   Update printer job count             07490000
         L     R14,PRJOBS          Load printer job count               07500000
         LR    R15,R14             Update counter                       07510000
         AH    R15,=H'1'           .                                    07520000
         CS    R14,R15,PRJOBS      .                                    07530000
         BNZ   PROCDS61            Loop if not updated                  07540000
PROCDS62 EQU   *                   Update printer page count            07550000
         L     R14,PRPAGES         Load printer page count              07560000
         LR    R15,R14             Update counter                       07570000
         A     R15,@STAT.TASKPGSP  . (add current page count)           07580000
         CS    R14,R15,PRPAGES     .                                    07590000
         BNZ   PROCDS62            Loop if not updated                  07600000
         DROP  R2                                                       07610000
                                                                        07620000
         ICM   R2,B'1111',SMF6PGE-SMFRCD6+SMF6 Bump page count          07630000
         A     R2,@STAT.TASKPGSP               .                        07640000
         STCM  R2,B'1111',SMF6PGE-SMFRCD6+SMF6 .                        07650000
         XC    @STAT.TASKJBST,@STAT.TASKJBST   Zero Job start time      07660000
         DROP  @STAT                                                    07670000
                                                                        07680000
PROCDS90 EQU   *             Close datasets                    PF980407 07690005
         MVC   MACAREA(OPENDL),OPEND Move open list skeleton            07700000
         LA    R1,MACAREA          Close 'AFPIN' DCB                    07710000
         LA    R2,AFPIN            .                                    07720000
         CLOSE ((R2),),MF=(E,(1)),MODE=31 .                             07730000
         FREEPOOL (R2)                                         PF010730 07740042
         NI    STATUS1,255-ST_INOPN    .. Indicate closed               07750000
         BAL   LINK,FREEIN         Free input dataset                   07760000
                                                                        07770000
         MVC   MACAREA(OPENDL),OPEND Move open list skeleton            07780000
         LA    R1,MACAREA          Close 'PCLOUT' DCB                   07790000
         LA    R2,PCLOUT           .                                    07800000
         CLOSE ((R2),),MF=(E,(1)),MODE=31 .                             07810000
         FREEPOOL (R2)                                         PF010730 07820042
         NI    STATUS1,255-ST_OTOPN    .. Indicate closed               07830000
         BAL   LINK,FREEOUT        Free output dataset                  07840000
                                                                        07850000
         SR    R1,R1               Bump number of datasets proc         07860000
         IC    R1,SMF6NDS-SMFRCD6+SMF6         .                        07870000
         LA    R1,1(,R1)                       .                        07880000
         STC   R1,SMF6NDS-SMFRCD6+SMF6         .                        07890000
         B     HASPREQ             Okay, Go process next dataset        07900000
                                                                        07910000
         TITLE 'PCLWTR1 - LBD External Writer - Error Routines'         07920000
*********************************************************************** 07930000
*        Error Routines                                               * 07940000
*********************************************************************** 07950000
                                                                        07960000
* ------------------------------- *                                     07970000
* Subsystem Interface error       *                                     07980000
* ------------------------------- *                                     07990000
BLDEM1   EQU   *                   'Subsystem interface error'          08000000
         ST    R15,DWD             Save Subsystem return code           08010000
         MVC   WTOAREA(EM1L),EM1   Move message to build area           08020000
         UNPK  EM1RC-EM1+WTOAREA(5),DWD+2(3) Format message    PF040398 08030002
         TR    EM1RC-EM1+WTOAREA(4),HEXTAB-C'0' Make code printab040398 08040002
         MVI   EM1RC-EM1+WTOAREA+4,C'/' Insert slash into messaPF040398 08050002
         UNPK  EM1REAS-EM1+WTOAREA(5),DWD(3)                   PF040398 08060002
         TR    EM1REAS-EM1+WTOAREA(4),HEXTAB-C'0' Make code print040398 08070002
         MVI   EM1REAS-EM1+WTOAREA+4,C' '                      PF040398 08080002
         BAL   LINK,MSGRTN         Display the message         PF040398 08090002
         B     EXIT                Go do WTO                   PF040398 08100002
                                                                        08110000
* ------------------------------- *                                     08120000
* Incorrect FONTLIB attributes    *                                     08130000
* ------------------------------- *                                     08140000
BLDEM2   EQU   *                   'Incorrect FONTLIB attributes'       08150000
         MVC   WTOAREA(EM2L),EM2   Move message to build area           08160000
         MVC   EM2DDN-EM2+WTOAREA(8),0(R15) Move DDname to message      08170002
         BAL   LINK,MSGRTN         Display the message         PF040398 08180002
         B     EXIT                Go do WTO                   PF040398 08190002
                                                                        08200000
* ------------------------------- *                                     08210000
* Load failure                    *                                     08220000
* ------------------------------- *                                     08230000
BLDEM3   EQU   *                   'Load failure'                       08240000
         MVC   WTOAREA(EM3L),EM3   Move message to build area           08250000
         BAL   LINK,MSGRTN         Display the message         PF040398 08260002
         B     EXIT                Go do WTO                   PF040398 08270002
                                                                        08280000
* ------------------------------- *                                     08290000
* LE error                        *                                     08300000
* ------------------------------- *                                     08310000
BLDEM4   EQU   *                   'LE error'                           08320000
         ST    R15,RC              Save return code                     08330000
         MVC   WTOAREA(EM4L),EM4   Move message to build area           08340000
         L     R1,PARMLIST         Load function code                   08350000
         L     R1,0(,R1)           .                                    08360000
         CVD   R1,DWD              .                                    08370000
         UNPK  EM4FUN-EM4+WTOAREA(2),DWD+6(2)                  PF040398 08380002
         OI    EM4FUN-EM4+WTOAREA+2,C'0'                       PF040398 08390002
         TR    EM4FUN-EM4+WTOAREA(2),HEXTAB-C'0' Make code prinPF040398 08400002
         L     R1,RC               Retrieve return code                 08410000
         CVD   R1,DWD              .                                    08420000
         UNPK  EM4RC-EM4+WTOAREA(2),DWD+6(2)                   PF040398 08430002
         OI    EM4RC-EM4+WTOAREA+2,C'0'                        PF040398 08440002
         TR    EM4RC-EM4+WTOAREA(2),HEXTAB-C'0' Make code printPF040398 08450002
         BAL   LINK,MSGRTN         Display the message         PF040398 08460002
         B     EXIT                Go do WTO                   PF040398 08470002
                                                                        08480000
* ------------------------------- *                                     08490000
* Dynalloc error                  *                                     08500000
* ------------------------------- *                                     08510000
BLDEM5   EQU   *                   'Dynalloc error'                     08520000
         MVC   WTOAREA(EM5L),EM5   Move message to build area           08530000
         UNPK  EM5ERR-EM5+WTOAREA(5),S99ERROR-S99RB+S99RBD(3)  PF040398 08540002
         TR    EM5ERR-EM5+WTOAREA(4),HEXTAB-C'0' Make code prinPF040398 08550002
         MVI   EM5ERR-EM5+WTOAREA+4,C' '                       PF040398 08560002
         BAL   LINK,MSGRTN         Display the message         PF040398 08570002
         B     EXIT                Go do WTO                   PF040398 08580002
                                                                        08590000
BLDEM5A  EQU   *                   'Dynalloc error' PF041116            08591046
         MVC   WTOAREA(EM5L),EM5   Move message to build area FF041116  08592046
         UNPK  EM5ERR-EM5+WTOAREA(5),S99ERROR-S99RB+S99RBD(3)  PF041116 08593046
         TR    EM5ERR-EM5+WTOAREA(4),HEXTAB-C'0' Make code prinPF041116 08594046
         MVI   EM5ERR-EM5+WTOAREA+4,C' '                       PF041116 08595046
         BAL   LINK,MSGRTN         Display the message         PF041116 08596046
         B     PROCDS90            Dine with this dataset      PF041116 08597046
*        Kludge, because I branch to these message routines             08597146
*        instrad of BAL.                                                08597246
                                                                        08598046
* ------------------------------- *                                     08600000
* Open error                      *                                     08610000
* ------------------------------- *                                     08620000
BLDEM6   EQU   *                   'Open error'                         08630000
         MVC   WTOAREA(EM6L),EM6   Move message to build area           08640000
         MVC   EM6DDN-EM6+WTOAREA(8),0(R15) Move DDname to messPF040398 08650002
         BAL   LINK,MSGRTN         Display the message         PF040398 08660002
         B     EXIT                Go do WTO                   PF040398 08670002
                                                                        08680000
* ------------------------------- *                                     08690000
* Subsystem error                 *                                     08700000
* ------------------------------- *                                     08710000
BLDEM7   EQU   *                   'Subsystem error'                    08720000
         MVC   WTOAREA(EM7L),EM7   Move message to build area           08730000
         UNPK  EM7ERR-EM7+WTOAREA(5),SSOBRETN+2(3)             PF040398 08740002
         TR    EM7ERR-EM7+WTOAREA(4),HEXTAB-C'0' Make code prinPF040398 08750002
         MVI   EM7ERR-EM7+WTOAREA+4,C' '                       PF040398 08760002
         BAL   LINK,MSGRTN         Display the message         PF040398 08770002
         B     EXIT                Go do WTO                   PF040398 08780002
                                                                        08790000
         SPACE 2                                                        08800002
* ------------------------------------------------------------------ *  08810003
* Display the error message                                          *  08820003
* Uses nonstandard call/return.                                      *  08830003
* Uese 'IORSAVE' as savearea; cannot be called from service routines.*  08840003
* ------------------------------------------------------------------ *  08850003
MSGRTN   DS    0H                  Console message routine     PF040398 08860002
         STM   R14,R12,12(R13)     Save registers              PF040398 08870002
         LA    R1,IORSAVE          Chain saveareas                      08880002
         ST    R1,8(,R13)          .                                    08890002
         ST    R13,4(,R1)          .                                    08900002
         LR    R13,R1              .                                    08910002
@WA      USING IORSAVE,R13         .                           PF040698 08920003
         MVC   EM1WTRN-EM1+@WA.WTOAREA,@WA.WTRNAME (same in all msgs)   08930003
         MVC   @WA.MACAREA(WTOSKLL),WTOSKL  MOVE skeleton WTO           08940003
         ICM   R1,B'1111',@WA.WTOAREA  Pick up routing and desc         08950003
         STCM  R1,B'0011',@WA.MACAREA+X'1C' Save Descriptor codes       08960003
         STCM  R1,B'1100',@WA.MACAREA+X'20' Save Routing codes          08970003
         SR    R0,R0               Clear console id            PF040398 08980002
         LA    R2,@WA.WTOAREA+4    Point to message length              08990003
         LA    R1,@WA.MACAREA         Point to WTO                      09000003
         WTO   TEXT=((R2)),MF=(E,(1)) Display the message      PF033198 09010002
         TM    @WA.STATUS1,ST_MSOPN   Q/ Is message dataset open?       09020003
         BNO   MSGEXIT                .. No, can't print       PF040398 09030003
         XC    @WA.MESSAGE+16(16),@WA.MESSAGE+16 Zero workarea          09040003
         LA    R3,@WA.MESSAGE+16      Output of 'TIME' macro            09050003
         MVC   @WA.MACAREA(TIMESKLL),TIMESKL                   PF040698 09060003
         LA    R4,@WA.MACAREA                                  PF040698 09070003
         TIME  DEC,(R3),LINKAGE=SYSTEM,MF=(E,(R4))             PF040398 09080003
         LTR   R15,R15                                                  09090003
         BNZ   ABEND                                                    09100003
         MVC   @WA.MESSAGE(9),=X'21207A20207A202020' Pat: 'HH:MM:SS0'   09110003
         MVI   @WA.MESSAGE+16+3,X'0C' Fix sign on time                  09120003
         ED    @WA.MESSAGE(9),@WA.MESSAGE+16                            09130003
         MVI   @WA.MESSAGE+8,C' '     Clear remainder of line           09140003
         MVC   @WA.MESSAGE+9(L'MESSAGE-9),@WA.MESSAGE+8                 09150003
         LH    R3,0(,R2)           L'WTO text                  PF040398 09160003
         BCTR  R3,0                Adjust for MVC              PF040398 09170002
         EX    R3,MVCMSG           Move message                PF040398 09180002
*        MVC   @WA.MESSAGE+10(*-*),2(R2)                                09190003
         LA    R1,@WA.SYSPRINT         Print the message                09200003
         LA    R0,@WA.MESSAGE                                           09210003
         PUT   (1),(0)                                         PF040398 09220002
MSGEXIT  EQU   *                   Message routine exit        PF040398 09230002
         L     R13,4(,R13)         Pop previous savearea       PF040398 09240002
         LM    R14,R12,12(R13)     Save registers              PF040398 09250002
         BR    LINK                Return to caller            PF040398 09260002
                                                                        09270002
*        EXecuted instruction                                  PF040398 09280002
MVCMSG   MVC   @WA.MESSAGE+9(*-*),2(R2)                                 09290003
                                                                        09300000
         TITLE 'PCLWTR1 - Free resources and return to caller'          09310000
* ------------------------------------ *                                09320000
* Free resources and return to caller  *                                09330000
* ------------------------------------ *                                09340000
EXIT     DS    0H                  Module exit                          09350000
         BAL   LINK,WRITESMF       Flush out last SMF record   PF990129 09360020
         MVI   SSSOFLG2,SSSOCTRL   Indicate processing completePF100697 09370000
*------- End Subsystem Interface (in supervisor state) --------PF100697 09380000
         MODESET MODE=SUP          Enter Supervisor State      PF100697 09390000
         LA    R1,SSPARM           Load A(SSOB Address)        PF100697 09400000
         IEFSSREQ                  Tell JES we're done         PF100697 09410000
         LR    R2,R15              Save return code            PF100697 09420000
         MODESET MODE=PROB         Leave Supervisor State      PF100697 09430000
         LR    R15,R2              Restore return code         PF100697 09440000
*------- End of supervisor state code -------------------------PF100697 09450000
EXIT0    EQU   *                                                        09460000
         TM    STATUS1,ST_MSOPN    Q/ Print D/S opened?                 09470000
         BNO   EXIT0A              .. No, Bypass close                  09480000
         MVC   MACAREA(OPENDL),OPEND Close print dataset                09490000
         LA    R1,MACAREA          .                                    09500000
         LA    R2,SYSPRINT         .                                    09510000
         CLOSE ((R2)),MF=(E,(1)),MODE=31 .                              09520000
         FREEPOOL (R2)             Free the buffer pool        PF990618 09530032
         NI    STATUS1,255-ST_MSOPN Indicate Closed                     09540000
EXIT0A   EQU   *                                                        09550000
         BAL   LINK,FREEP          Unallocate                           09560000
                                                                        09570000
EXIT1    EQU   *                                                        09580000
         TM    STATUS1,ST_INOPN    Q/ Input D/S opened?                 09590000
         BNO   EXIT1A              .. No, Bypass close                  09600000
         MVC   MACAREA(OPENDL),OPEND Close print dataset                09610000
         LA    R1,MACAREA          .                                    09620000
         LA    R2,AFPIN            .                                    09630000
         CLOSE ((R2)),MF=(E,(1)),MODE=31 .                              09640000
         FREEPOOL (R2)             Free the buffer pool        PF990618 09650032
         NI    STATUS1,255-ST_INOPN Indicate Closed                     09660000
EXIT1A   EQU   *                                                        09670000
         MVI   S99DSP2-S99LISTD+S99T,OVDSPK Keep the dataset if error   09680000
         BAL   LINK,FREEIN         Unallocate                           09690000
                                                                        09700000
EXIT2    EQU   *                                                        09710000
         TM    STATUS1,ST_OTOPN    Q/ Output D/S opened?                09720000
         BNO   EXIT2A              .. No, Bypass close                  09730000
         MVC   MACAREA(OPENDL),OPEND Close print dataset                09740000
         LA    R1,MACAREA          .                                    09750000
         LA    R2,PCLOUT           .                                    09760000
         CLOSE ((R2)),MF=(E,(1)),MODE=31 .                              09770000
         FREEPOOL (R2)             Free the buffer pool        PF990618 09780032
         NI    STATUS1,255-ST_OTOPN Indicate Closed                     09790000
EXIT2A   EQU   *                                                        09800000
         BAL   LINK,FREEOUT        Unallocate                           09810000
                                                                        09820000
EXIT3    EQU   *                                                        09830000
         TM    STATUS1,ST_FTOPN    Q/ FONTLIB opened?                   09840000
         BNO   EXIT3A              .. No, Bypass close                  09850000
         MVC   MACAREA(OPENDL),OPEND Close print dataset                09860000
         LA    R1,MACAREA          .                                    09870000
         LA    R2,FONTLIB          .                                    09880000
         CLOSE ((R2)),MF=(E,(1)),MODE=31 .                              09890000
         FREEPOOL (R2)             Free the buffer pool        PF990618 09900032
         NI    STATUS1,255-ST_FTOPN Indicate Closed                     09910000
         TM    STATUS,ST_FTBFF     Q/ Do we have buffer to free?        09920000
         BNO   EXIT3A              .. no                                09930000
         L     R1,FNTBUF           .. yes, free it                      09940000
         L     R0,FNTBUFL          .                                    09950000
         STORAGE RELEASE,LENGTH=(0),ADDR=(1)                            09960000
         NI    STATUS,255-ST_FTBFF Indicate buffer freed                09970000
EXIT3A   EQU   *                                                        09980000
*        FONTLIB is not dynamically allocated,                          09990000
*                so no need to deallocate...                            10000000
                                                                        10010000
EXIT4    EQU   *                                                        10020000
         TM    STATUS1+1,ST_WTOPN  Q/ WIDTAB opened?                    10030000
         BNO   EXIT4A              .. No, Bypass close                  10040000
         MVC   MACAREA(OPENDL),OPEND Close print dataset                10050000
         LA    R1,MACAREA          .                                    10060000
         LA    R2,WIDTAB           .                                    10070000
         CLOSE ((R2)),MF=(E,(1)),MODE=31 .                              10080000
         FREEPOOL (R2)             Free the buffer pool        PF990618 10090032
         NI    STATUS1+1,255-ST_WTOPN Indicate Closed                   10100000
         TM    STATUS,ST_WTBFF     Q/ Do we have buffer to free?        10110000
         BNO   EXIT4A              .. no                                10120000
         L     R1,WIDBUF           .. yes, free it                      10130000
         L     R0,WIDBUFL          .                                    10140000
         STORAGE RELEASE,LENGTH=(0),ADDR=(1)                            10150000
         NI    STATUS,255-ST_WTBFF Indicate buffer freed                10160000
EXIT4A   EQU   *                                                        10170000
*        WIDTAB  is not dynamically allocated,                          10180000
*                so no need to deallocate...                            10190000
                                                                        10200000
EXIT5    EQU   *                                                        10210000
         TM    STATUS1+1,ST_SGOPN  Q/ SEGLIB opened?                    10220000
         BNO   EXIT5A              .. No, Bypass close                  10230000
         MVC   MACAREA(OPENDL),OPEND Close print dataset                10240000
         LA    R1,MACAREA          .                                    10250000
         LA    R2,SEGLIB           .                                    10260000
         CLOSE ((R2)),MF=(E,(1)),MODE=31 .                              10270000
         FREEPOOL (R2)             Free the buffer pool        PF990618 10280032
         NI    STATUS1+1,255-ST_SGOPN Indicate Closed                   10290000
         TM    STATUS,ST_SGBFF     Q/ Do we have buffer to free?        10300000
         BNO   EXIT5A              .. no                                10310000
         L     R1,SEGBUF           .. yes, free it                      10320000
         L     R0,SEGBUFL          .                                    10330000
         STORAGE RELEASE,LENGTH=(0),ADDR=(1)                            10340000
         NI    STATUS,255-ST_SGBFF Indicate buffer freed                10350000
EXIT5A   EQU   *                                                        10360000
*        SEGLIB  is not dynamically allocated,                          10370000
*                so no need to deallocate...                            10380000
                                                                        10390000
EXIT9    EQU   *                                                        10400000
         LR    R1,R13              Load address to freemain             10410000
         L     R13,4(,R13)         Load Caller's savearea address       10420000
         STORAGE RELEASE,LENGTH=WRKLEN+4096,ADDR=(1) Free workaPF030498 10430000
         RETURN (14,12),RC=0       Return to caller                     10440000
                                                                        10450000
         SPACE 2                                                        10460009
* ------------------------------- *                                     10470000
* Abend program                   *                                     10480000
* ------------------------------- *                                     10490000
ABEND    EQU   *                   ABEND this job                       10500000
         ABEND 1,DUMP                                                   10510000
                                                                        10520000
         TITLE 'PCLWTR1 - LBD External Writer - Dynamic allocation'     10530000
*********************************************************************** 10540000
*        Allocate input dataset                                       * 10550000
*********************************************************************** 10560000
ALLOCIN  DS    0H                                                       10570000
         MVC   S99DSN1-S99LISTD+S99T,SSSODSN  (DSNAME)                  10580000
         MVC   S99DDN1-S99LISTD+S99T,BLANKS   (DDNAME)                  10590000
         LA    R1,S99L1-S99LISTD+S99T Point to alloc parameter list     10600000
         ST    R1,S99TXTPP-S99RB+S99RBD      .                          10610000
         MVI   S99VERB-S99RB+S99RBD,S99VRBAL  (Verb code)               10620000
         LA    R1,S99RBA           Load A(DYNALLOC Rqst blk)            10630000
         DYNALLOC ,                Allocate the dataset                 10640000
         LTR   R15,R15             Test DYNALLOC return code            10650000
         BNZ   BLDEM5              .. Error                             10660000
         MVC   DCBDDNAM-IHADCB+AFPIN,S99DDN1-S99LISTD+S99T Save DDname  10670000
         OI    STATUS1,ST_INALC    Indicate 'allocated'                 10680000
         BR    LINK                Return to caller                     10690000
                                                                        10700000
*********************************************************************** 10710000
*        Allocate output dataset                                      * 10720000
*********************************************************************** 10730000
ALLOCOT  DS    0H                  Allocate output dataset              10740000
         MVC   S99FMN3-S99LISTD+S99T(4),=CL4'STD' Default frm  PF981026 10750009
         TM    STATUS3,ST_OA       Q/ 'OUTADD' done?           PF021098 10760000
         BNO   ALLOCOT1            .. No                       PF021098 10770000
         NI    STATUS3,255-ST_OA   .. Yes, reset flag          PF021098 10780000
         MVC   MACAREA(OUTDELL),OUTDEL Move Plist              PF021098 10790000
         LA    R1,MACAREA          'OUTDEL'                    PF021098 10800000
         OUTDEL NAME=PCL_OD1,MF=(E,(1))                        PF021098 10810000
ALLOCOT1 EQU   *                   Bypass 'OUTDEL'             PF021098 10820000
         OI    S99L3E-S99LISTD+S99T,X'80'  Set 'last' flag              10830000
         L     R1,A2P_PRTT-AFP2PCL_PARM+A2P_PARM Get dest      PF021097 10840000
*        CLC   =C'XXP',PRID-PRINTER(R1) Q/ Is dest 'XXPx'?     PF021098 10850000
*        BNE   ALLOCOT5            .. Nope                     PF981026 10860011
         NI    S99L3E-S99LISTD+S99T,255-X'80'  Reset 'last' flag        10870000
         MVC   MACAREA(OUTADDL),OUTADD Move Plist              PF021098 10880000
         LA    R1,OUTTU-OUTADD+MACAREA Load A(Text unit)       PF021098 10890000
         ST    R1,OUTTUA-OUTADD+MACAREA Save address           PF021098 10900000
         OI    OUTTUA-OUTADD+MACAREA,X'80' Flag EOL            PF021098 10910000
         MVC   OUTGRP-OUTADD+MACAREA(8),SSSOJOBN               PF021098 10920000
         LA    R1,MACAREA          'OUTADD'                    PF021098 10930000
         LA    R2,OUTTUA-OUTADD+MACAREA Point to TU addr       PF021098 10940000
         OUTADD NAME=PCL_OD1,TEXTPTR=(R2),MF=(E,(1))           PF021098 10950000
         OI    STATUS3,ST_OA       Set flag                    PF021098 10960000
ALLOCOT5 EQU   *                   Bypass 'OUTADD'             PF021098 10970000
         TM    STATUS2,ST_META     Q/ Metacode input?          PF981026 10980011
         BNO   ALLOCOT6            .. no                       PF981026 10990011
         CLC   SSSODEST,=C'METACODE' Q/ DEST=METACODE          PF020115 11000043
         BE    ALLOCOT6              .. Yes, bypass form       PF020115 11010043
         MVC   S99FMN3-S99LISTD+S99T(4),=CL4'LPGE' Metacode frmPF990427 11020031
ALLOCOT6 EQU   *                                               PF021098 11030011
         LA    R1,S99L3-S99LISTD+S99T Point to alloc parameter list     11040000
         ST    R1,S99TXTPP-S99RB+S99RBD      .                          11050000
         MVI   S99VERB-S99RB+S99RBD,S99VRBAL  (Verb code)               11060000
         MVC   S99DST3-S99LISTD+S99T,DEST     (Destination)             11070000
         MVC   S99OUT3-S99LISTD+S99T,PCL_OD1  (Output desc)             11080000
         LA    R1,S99RBA           Load A(DYNALLOC Rqst blk)            11090000
         DYNALLOC ,                Allocate the dataset                 11100000
         LTR   R15,R15             Test DYNALLOC return code            11110000
         BNZ   BLDEM5A             .. Error                    PF041116 11120046
         MVC   DCBDDNAM-IHADCB+PCLOUT,S99DDN1-S99LISTD+S99T Save DDname 11130000
         OI    STATUS1,ST_OTALC    Indicate dataset allocated           11140000
         BR    LINK                Return to caller                     11150000
                                                                        11160000
*********************************************************************** 11170000
*        Allocate SYSPRINT dataset                                    * 11180000
*********************************************************************** 11190000
ALLOCP   DS    0H                  Allocate output dataset              11200000
         LA    R1,S99L5-S99LISTD+S99T Point to alloc parameter list     11210000
         ST    R1,S99TXTPP-S99RB+S99RBD      .                          11220000
         MVI   S99VERB-S99RB+S99RBD,S99VRBAL  (Verb code)               11230000
         LA    R1,S99RBA           Load A(DYNALLOC Rqst blk)            11240000
         DYNALLOC ,                Allocate the dataset                 11250000
         LTR   R15,R15             Test DYNALLOC return code            11260000
         BNZ   BLDEM5              .. Error                             11270000
         OI    STATUS1,ST_MSALC    Indicate dataset allocated           11280000
         BR    LINK                Return to caller                     11290000
                                                                        11300000
*********************************************************************** 11310000
*        Unallocate input dataset                                     * 11320000
*********************************************************************** 11330000
FREEIN   DS    0H                                                       11340000
         TM    STATUS1,ST_INALC    Q/ Input dataset allocated?          11350000
         BNO   FREEINX             .. No                                11360000
         MVC   S99DDN2-S99LISTD+S99T,DCBDDNAM-IHADCB+AFPIN              11370000
         LA    R1,S99L2-S99LISTD+S99T Point to unalloc parameter list   11380000
         ST    R1,S99TXTPP-S99RB+S99RBD      .                          11390000
         MVI   S99VERB-S99RB+S99RBD,S99VRBUN  (Verb code)               11400000
                                                                        11410000
*------- Execute subsystem unallocation in supervisor state -----*    * 11420000
*        (Must be in supervisor state to issue delete)           |      11430000
         MODESET MODE=SUP          Enter Supervisor State        |    * 11440000
         LA    R1,S99RBA           Load A(DYNALLOC Rqst blk)     |    * 11450000
         DYNALLOC ,                Unallocate the dataset        |    * 11460000
         LR    R2,R15              Save return code              |    * 11470000
         MODESET MODE=PROB         Leave Supervisor State        |    * 11480000
         LR    R15,R2              Restore return code           |    * 11490000
*------- End of supervisor state code ---------------------------*    * 11500000
                                                                        11510000
         NI    STATUS1,255-ST_INALC Indicate not allocated              11520000
         LTR   R15,R15             Test DYNALLOC return code            11530000
         BNZ   BLDEM5              .. Error                             11540000
FREEINX  EQU   *                                                        11550000
         BR    LINK                Return to caller                     11560000
                                                                        11570000
*********************************************************************** 11580000
*        UNALLOCATE OUTPUT DATASET                                    * 11590000
*********************************************************************** 11600000
FREEOUT  DS    0H                                                       11610000
         TM    STATUS1,ST_OTALC     Q/ Dataset allocated?               11620000
         BNO   FREEOUTX            .. No, Don't unallocate              11630000
         MVC   S99DDN4-S99LISTD+S99T,DCBDDNAM-IHADCB+PCLOUT             11640000
         MVC   S99DST4-S99LISTD+S99T,A2P_DEST Move output dest          11650000
         MVC   S99CLS4-S99LISTD+S99T,A2P_CLAS Move output classPF000518 11660036
         LA    R1,S99L4-S99LISTD+S99T Point to unalloc parameter list   11670000
         ST    R1,S99TXTPP-S99RB+S99RBD      .                          11680000
         MVI   S99VERB-S99RB+S99RBD,S99VRBUN  (Verb code)               11690000
         LA    R1,S99RBA           Load A(DYNALLOC Rqst blk)            11700000
         DYNALLOC ,                Unallocate the dataset               11710000
         NI    STATUS1,255-ST_OTALC Indicate dataset not allocated      11720000
         LTR   R15,R15             Test DYNALLOC return code            11730000
         BNZ   BLDEM5              .. Error                             11740000
FREEOUTX EQU   *                                                        11750000
         BR    LINK                Return to caller                     11760000
                                                                        11770000
*********************************************************************** 11780000
*        Unallocate SYSPRINT dataset                                  * 11790000
*********************************************************************** 11800000
FREEP    DS    0H                                                       11810000
         TM    STATUS1,ST_MSALC    Q/ Dataset allocated?                11820000
         BNO   FREEPX              .. No, Don't unallocate              11830000
         MVC   S99DDN6-S99LISTD+S99T,PRTDD Move SYSPRINT DDname         11840000
         LA    R1,S99L6-S99LISTD+S99T Point to unalloc parameter list   11850000
         ST    R1,S99TXTPP-S99RB+S99RBD      .                          11860000
         MVI   S99VERB-S99RB+S99RBD,S99VRBUN  (Verb code)               11870000
         LA    R1,S99RBA           Load A(DYNALLOC Rqst blk)            11880000
         DYNALLOC ,                Unallocate the dataset               11890000
         NI    STATUS1,255-ST_MSALC Indicate dataset not allocated      11900000
         LTR   R15,R15             Test DYNALLOC return code            11910000
         BNZ   BLDEM5              .. Error                             11920000
FREEPX   EQU   *                                                        11930000
         BR    LINK                Return to caller                     11940000
                                                                        11950000
         TITLE 'PCLWTR1 - LBD External Writer - Write SMF Type 6  Recor+11960000
               d'                                                       11970000
*********************************************************************** 11980000
*        Write SMF type 6 record                                      * 11990000
*********************************************************************** 12000000
WRITESMF DS    0H                  Write SMF type 6 record              12010000
         LA    R2,SMF6             Point to SMF record                  12020000
         USING SMFRCD6,R2          Tell Assembler where it's at         12030000
         CLI   SMF6NDS,0           Q/ Any datasets this record?         12040000
         BZ    SMFBYP              .. No. bypass the write              12050000
         LA    R1,SMF6             Load A(SMF record)                   12060000
         SMFWTM (1)                Write the record            PF990127 12070017
SMFBYP   EQU   *                   Build next SMF 6 record              12080000
         XC    SMF6,SMF6           Initialize SMF record                12090021
         MVI   SMF6FLG-SMFRCD6+SMF6,X'1E' Move header flag     PG990129 12100024
         MVI   SMF6RTY-SMFRCD6+SMF6,X'06' Move record type              12110024
         MVC   SMF6LEN-SMFRCD6+SMF6,=AL2(L'SMF6)  .    length           12120000
         OI    SMF6INDC,SMF6J2L3         Set JES level                  12130000
         OI    SMF6PAD1,SMF6REXT   Common  extension present   PF990129 12140020
         MVC   SMF6LN1,=AL2(L'SMF6SIZ3)  Length of common ext.          12150020
         MVC   SMF6JBN,SSSOJOBN    Move Job name                        12160000
         MVC   SMF6FMN,SSSOFORM    Move Form number                     12170000
         MVC   SMF6OWC,SSSOCLAS    Move SYSOUT class                    12180000
         LA    R1,SMF6END2         Point to common ext.        PF990129 12190020
         MVC   SMF6LN3-SMF6LN3(,R1),=AL2(L'SMF6DSIZ)           PF990129 12200022
         MVC   SMF6EFMN-SMF6LN3(8,R1),=CL8' '                  PF990129 12210020
         MVC   SMF6EFMN-SMF6LN3(4,R1),SSSOFORM                 PF990129 12220020
         MVC   SMF6JBID-SMF6LN3(8,R1),SSSOJOBI                 PF990129 12230024
         MVC   SMF6PRMD-SMF6LN3(8,R1),=CL8'PAGE    '           PF990129 12240020
         MVC   SMF6JNM,=C'0000'    Default job number                   12250020
         CLI   SSSOJOBI+3,C'9'     Q/ 4-digit job number?               12260000
         BH    SMFJNM              .. Yes, get job number               12270000
         CLI   SSSOJOBI+3,C'1'                                          12280000
         BNL   SMFCONT             .. No, use zeros                     12290000
SMFJNM   EQU   *                   Get job number and drop leading '0'  12300000
         MVC   OLDJOBI,SSSOJOBI    Save complete job id                 12310000
         MVC   SMF6JNM,SSSOJOBI+3  Move Job number                      12320000
         LA    R1,SMF6JNM          Point to start of field              12330000
         LA    R0,SMF6JNM+4        Point to end of field                12340000
SMFLOOP  EQU   *                   Drop leading zeros                   12350000
         CLI   0(R1),C'0'          Q/ Leading zero?                     12360000
         BNE   SMFCONT             .. No, all done                      12370000
         MVI   0(R1),C' '          .. Yes, blank it out                 12380000
         LA    R1,1(,R1)           Bump pointer                         12390000
         CR    R1,R0               Q/ End of field?                     12400000
         BL    SMFLOOP             .. No, keep going                    12410000
SMFCONT  EQU   *                                                        12420000
         L     R1,SSSOWTRC         Point to Job Log data                12430000
         MVC   SMF6RST(SMF6UIF+L'SMF6UIF-SMF6RST),4(R1)                X12440000
                                   Move Job log data                    12450000
         TIME  BIN                 Get current time and date            12460000
         STCM  R0,X'F',SMF6WST     Save time in SMF record              12470000
         STCM  R1,X'F',SMF6WST+4   Save date in SMF record              12480000
         BR    LINK                Return to caller                     12490000
         DROP  R2                                                       12500000
                                                                        12510000
*********************************************************************** 12520000
*        Copy Linemode data                                           * 12530000
*********************************************************************** 12540000
LINEMODE DS    0H                                                       12550000
         LR    R5,R13              Load A(workarea)                     12560000
         LA    R1,PARMLIST+8       Build parm list for read             12570000
         ST    R1,PARMLIST         A(record_locator)                    12580000
         LA    R1,PARMLIST+12      .                                    12590000
         ST    R1,PARMLIST+4       A(record_length)                     12600000
         OI    PARMLIST+4,X'80'                                         12610000
LINEMOD1 EQU   *                   Read/Write loop                      12620000
         LA    R1,PARMLIST         Read a record                        12630000
         L     R15,=A(READRTN)     .                                    12640000
         BALR  R14,R15             .                                    12650000
         ICM   R0,B'1111',PARMLIST+12 Test for EOF                      12660000
         BM    LINEMODX               .                                 12670000
         L     R0,PARMLIST+8       Load record address                  12680000
         SH    R0,=H'4'            Back up to start of VRL              12690000
         ST    R0,PARMLIST+8       .                                    12700000
         LA    R1,PARMLIST         Write a record                       12710000
         L     R15,=A(PNCHRTN)     .                                    12720000
         BALR  R14,R15             .                                    12730000
         B     LINEMOD1            Until done                           12740000
LINEMODX EQU   *                                                        12750000
         BR    LINK                Return to caller                     12760000
*                                                                       12770000
         DROP  ,                   Drop all USINGs                      12780000
                                                                        12790000
         TITLE 'PCLWTR1 - LBD External Writer - Constants'              12800000
*********************************************************************** 12810000
*        Constants and static storage                                 * 12820000
*********************************************************************** 12830000
         LTORG *                                                        12840000
*                                                                       12850000
* ------------------------------- *                                     12860000
*        Miscellaneous constants  *                                     12870000
* ------------------------------- *                                     12880000
BLANKS   DC    CL8' '                                                   12890000
HEXTAB   DC    C'0123456789ABCDEF' Hex character table                  12900000
AZERO    DC    A(ZERO)             A(service routine table)             12910000
ZERO     DC    F'0'                Dummy table, no entries              12920000
INITSUB  DC    F'3'                PIPI function code - Initialize      12930000
CALLSUB  DC    F'4'                PIPI function code - Call subr.      12940000
CALLSUBA DC    F'10'               PIPI function code - Call sub Addr.  12950000
PCL_OD1  DC    CL8'PCL1'           Output descriptor name               12960000
                                                                        12970000
POPT     DS    0F                  Run time options - production        12980006
         DC    C'TRAP(ON)'                                     PF030498 12990000
POPTL    EQU   *-POPT              Length of options                    13000006
                                                                        13010006
TOPT     DS    0F                  Run time options - test     PF980407 13020006
         DC    C'TRAP(OFF)'                                    PF980407 13030006
TOPTL    EQU   *-TOPT              Length of options           PF980407 13040006
*                                                                       13050000
WTRSSOB  EQU   *                   Initializer for SSOB                 13060000
         DC    CL4'SSOB'           Control block ID                     13070000
         DC    AL2(SSOBHSIZ)       SSOB header length                   13080000
         DC    AL2(SSOBSOUT)       SSOB type                            13090000
WTRSOSIZ EQU   *-WTRSSOB           L'initializer                        13100000
                                                                        13110000
         SPACE 2                                                        13120000
* ------------------------------- *                                     13130000
*        Macro Skeletons          *                                     13140000
* ------------------------------- *                                     13150000
ESTAE    ESTAEX STAERTN,MF=L                                            13160000
ESTALEN  EQU   *-ESTAE                                                  13170000
                                                                        13180000
OUTADD   OUTADD MF=L                                           PF020598 13190000
OUTTUP   DS    0F            Text unit skeleton                PF020598 13200000
OUTTUA   DC    A(0)          A(Text unit)                      PF020598 13210000
OUTTU    DS    0F            Text unit one                     PF020598 13220000
         DC    AL2(DOGROUPI) Key - OUTGROUP                    PF020598 13230000
         DC    AL2(1)        Num of len/param pairs            PF020598 13240000
         DC    AL2(8)        Length of first param             PF020598 13250000
OUTGRP   DC    CL8' '        Outgroup                          PF020598 13260000
OUTADDL  EQU   *-OUTADD                                        PF020598 13270000
                                                                        13280000
OUTDEL   OUTDEL MF=L                                           PF020598 13290000
OUTDELL  EQU   *-OUTDEL                                        PF020598 13300000
                                                                        13310000
WTOSKL   WTO   TEXT=*-*,MF=L                                   PF040398 13320001
WTOSKLL  EQU   *-WTOSKL                                        PF100697 13330000
                                                                        13340000
TIMESKL  TIME  LINKAGE=SYSTEM,MF=L                             PF040698 13350003
TIMESKLL EQU   *-TIMESKL                                       PF040698 13360003
                                                                        13370003
SYSPRNTD DCB   DDNAME=SYSPRINT,                                        +13380000
               DSORG=PS,                                               +13390000
               BLKSIZE=0,                                              +13400000
               LRECL=120,                                              +13410000
               RECFM=FB,                                               +13420000
               MACRF=(PM)                                               13430000
SYSPRTDL EQU   *-SYSPRNTD                                               13440000
                                                                        13450000
AFPIND   DCB   DDNAME=AFPIN,                                           +13460000
               DSORG=PS,                                               +13470000
               BLKSIZE=12288,                                          +13480000
               EODAD=RDEOF,                                            +13490000
               LRECL=12284,                                            +13500000
               RECFM=VBM,                                              +13510000
               MACRF=(GL)                                               13520000
AFPINDL  EQU   *-AFPIND                                                 13530000
                                                                        13540000
PCLOUTD  DCB   DDNAME=PCLOUT,                                          +13550000
               DSORG=PS,                                               +13560000
               BLKSIZE=4000,                                           +13570000
               LRECL=80,                                               +13580000
               RECFM=FB,                                               +13590000
               MACRF=(PM)                                               13600000
PCLOUTDL EQU   *-PCLOUTD                                                13610000
                                                                        13620008
METAOUTD DCB   DDNAME=METAOUT,                                 PF981026+13630008
               DSORG=PS,                                       PF981026+13640008
               BLKSIZE=4066,                                   PF981026+13650008
               LRECL=214,                                      PF981026+13660008
               RECFM=FBA,                                      PF981026+13670008
               MACRF=(PM)                                      PF981026 13680008
METAOUTL EQU   *-METAOUTD                                      PF981026 13690008
                                                                        13700000
FONTLBD  DCB   DDNAME=FONTLIB,                                         +13710000
               DSORG=PO,                                               +13720000
               EODAD=FNTEOF,                                           +13730000
               BLKSIZE=0,                                              +13740000
               LRECL=80,                                               +13750000
               RECFM=FB,                                               +13760000
               MACRF=(R)                                                13770000
FONTLBDL EQU   *-FONTLBD                                                13780000
                                                                        13790000
WIDTABD  DCB   DDNAME=WIDTHS,                                          +13800000
               DSORG=PO,                                               +13810000
               EODAD=WIDEOF,                                           +13820000
               BLKSIZE=0,                                              +13830000
               RECFM=VBM,                                              +13840000
               MACRF=(R)                                                13850000
WIDTABDL EQU   *-WIDTABD                                                13860000
                                                                        13870000
SEGLIBD  DCB   DDNAME=SEGLIB,                                  PF980311+13880000
               DSORG=PO,                                       PF980311+13890000
               EODAD=SEGEOF,                                   PF980311+13900000
               BLKSIZE=0,                                      PF980311+13910000
               RECFM=VBM,                                      PF980311+13920000
               MACRF=(R)                                       PF980311 13930000
SEGLIBDL EQU   *-SEGLIBD                                       PF980311 13940000
                                                                        13950000
OPEND    OPEN  (,(INPUT)),MF=L,MODE=31                                  13960000
OPENDL   EQU   *-OPEND                                                  13970000
         SPACE 2                                                        13980000
* ------------------------------- *                                     13990000
*        LE PIPI Table            *                                     14000000
* ------------------------------- *                                     14010000
         PRINT GEN                                                      14020000
APIPITAB DC    A(PIPITAB)          A(table)                             14030000
PIPITAB  CEEXPIT                   Dummy table                          14040000
         CEEXPITY AFP2PCL2                                              14050000
         CEEXPITY ,                Dummy entry                          14060000
         CEEXPITS                  End of table                         14070000
         PRINT NOGEN                                                    14080000
*                                                                       14090000
         SPACE 3                                                        14100000
* ------------------------------- *                                     14110000
*        Error messages           *                                     14120000
* ------------------------------- *                                     14130000
EM1      DS    0H                                              PF040298 14140001
         BITON (1,7,10)           Routing codes                PF040398 14150001
         BITON (4)                Descriptor codes             PF040398 14160001
EM1X     EQU   *                  Message                      PF040398 14170001
         DC    AL2(EM1L-6)        Length of text               PF040298 14180002
         DC    C'LBD311E '                                     PF040398 14190002
EM1WTRN  DC    C'wwwwwwww'                                     PF040298 14200000
         DC    C' Writer closed - Subsystem interface error '           14210003
EM1RC    DC    C'xxxx'                                                  14220000
         DC    C'/'                                                     14230000
EM1REAS  DC    C'yyyy'                                                  14240000
         DC    C' '                                                     14250000
EM1L     EQU   *-EM1                                                    14260002
                                                                        14270000
EM2      DS    0H                                              PF040298 14280001
         BITON (7,10)             Routing codes                PF040398 14290001
         BITON (4)                Descriptor codes             PF040398 14300001
EM2X     EQU   *                  Message                      PF040398 14310001
         DC    AL2(EM2L-6)        Length of text               PF040298 14320002
         DC    C'LBD312E '                                     PF040398 14330002
EM2WTRN  DC    C'wwwwwwww'                                     PF040298 14340000
         DC    C' Writer closed - Invalid '                             14350003
EM2DDN   DC    C'xxxxxxxx'                                              14360000
         DC    C' attributes.'                                          14370000
EM2L     EQU   *-EM2                                                    14380002
                                                                        14390000
EM3      DS    0H                                              PF040298 14400001
         BITON (7,10)             Routing codes                PF040398 14410001
         BITON (4)                Descriptor codes             PF040398 14420001
EM3X     EQU   *                  Message                      PF040398 14430001
         DC    AL2(EM3L-6)        Length of text               PF040298 14440002
         DC    C'LBD313E '                                     PF040398 14450002
EM3WTRN  DC    C'wwwwwwww'                                     PF040298 14460000
         DC    C' Writer closed - Program load failed'                  14470003
EM3L     EQU   *-EM3                                                    14480002
                                                                        14490000
EM4      DS    0H                                              PF040298 14500001
         BITON (7,10)             Routing codes                PF040398 14510001
         BITON (4)                Descriptor codes             PF040398 14520001
EM4X     EQU   *                  Message                      PF040398 14530001
         DC    AL2(EM4L-6)        Length of text               PF040298 14540002
         DC    C'LBD314E '                                     PF040398 14550002
EM4WTRN  DC    C'wwwwwwww'                                     PF040298 14560000
         DC    C' Writer closed - LE error, function='                  14570003
EM4FUN   DC    C'xx'                                                    14580000
         DC    C', rc='                                                 14590000
EM4RC    DC    C'yy'                                                    14600000
EM4L     EQU   *-EM4                                                    14610002
                                                                        14620000
EM5      DS    0H                                              PF040298 14630001
         BITON (7,10)             Routing codes                PF040398 14640001
         BITON (4)                Descriptor codes             PF040398 14650001
EM5X     EQU   *                  Message                      PF040398 14660001
         DC    AL2(EM5L-6)        Length of text               PF040298 14670002
         DC    C'LBD315E '                                     PF040398 14680002
EM5WTRN  DC    C'wwwwwwww'                                     PF040298 14690000
         DC    C' Writer closed - DYNALLOC error '                      14700003
EM5ERR   DC    C'nnnn '                                                 14710002
EM5L     EQU   *-EM5                                                    14720002
                                                                        14730000
EM6      DS    0H                                              PF040298 14740001
         BITON (7,10)             Routing codes                PF040398 14750001
         BITON (4)                Descriptor codes             PF040398 14760001
EM6X     EQU   *                  Message                      PF040398 14770001
         DC    AL2(EM6L-6)        Length of text               PF040298 14780002
         DC    C'LBD316E '                                     PF040398 14790002
EM6WTRN  DC    C'wwwwwwww'                                     PF040298 14800000
         DC    C' Writer closed - OPEN error for '                      14810003
EM6DDN   DC    C'12345678'                                     PF040398 14820002
EM6L     EQU   *-EM6                                                    14830002
                                                                        14840000
EM7      DS    0H                                              PF040298 14850001
         BITON (2,7)              Routing codes                PF040398 14860001
         BITON (3)                Descriptor codes             PF040398 14870001
EM7X     EQU   *                  Message                      PF040398 14880001
         DC    AL2(EM7L-6)        Length of text               PF040298 14890002
         DC    C'LBD317E '                                     PF040398 14900002
EM7WTRN  DC    C'wwwwwwww'                                     PF040298 14910000
         DC    C' Writer closed - Subsystem error '                     14920003
EM7ERR   DC    C'nnnn'                                                  14930000
         DC    C' '                                                     14940000
EM7L     EQU   *-EM7                                                    14950002
                                                                        14960000
M8       DS    0H                                              PF040298 14970001
         BITON (7)                Routing codes                PF040398 14980001
         BITON (6)                Descriptor codes             PF040398 14990001
M8X      EQU   *                  Message                      PF040398 15000001
         DC    AL2(M8L-6)         Length of text               PF100697 15010002
         DC    C'LBD318I '                                     PF040398 15020002
M8WTRN   DC    C'wwwwwwww'                                     PF040298 15030000
         DC    C' Start job '                                  PF100697 15040002
M8JOB    DC    C'jjjjjjjj(iiiiiiii)'                           PF100697 15050000
         DC    C' '                                            PF100697 15060000
M8TYP    DC    C'*AFP* '          Datastream type              PF100697 15070000
         DC    C',D='                                          PF100697 15080000
M8DEST   DC    C'dddddddd'                                     PF100697 15090000
M8L      EQU   *-M8                                            PF100697 15100002
                                                                        15110000
M9       DS    0H                                              PF040298 15120001
         BITON (7)                Routing codes                PF040398 15130001
         BITON (6)                Descriptor codes             PF040398 15140001
M9X      EQU   *                  Message                      PF040398 15150001
         DC    AL2(M9L-6)         Length of text               PF100697 15160002
         DC    C'LBD319I '                                     PF040398 15170002
M9WTRN   DC    C'wwwwwwww'                                     PF040298 15180000
         DC    C' End job '                                    PF100697 15190002
M9JOB    DC    C'jjjjjjjj(iiiiiiii),'                          PF101097 15200000
         DC    C' RC='                                         PF101097 15210000
M9RC     DC    C'rr'                                           PF100697 15220000
M9L      EQU   *-M9                                            PF100697 15230002
                                                                        15240002
E320     DS    0H                                              PF001127 15250038
         BITON (7)                Routing codes                PF001127 15260038
         BITON (4)                Descriptor codes             PF001127 15270038
E320X    EQU   *                  Message                      PF001127 15280038
         DC    AL2(E320L-6)       Length of text               PF001127 15290038
         DC    C'LBD320E '                                     PF001127 15300038
E320WTRN DC    C'wwwwwwww'                                     PF001127 15310038
         DC    C' '                                            PF001127 15320038
E320PRT  DC    C'dddddddd'                                     PF001127 15330038
         DC    C' is not a PCL printer'                        PF001127 15340038
E320L    EQU   *-E320                                          PF001127 15350038
                                                                        15360000
M11      DS    0H                                              PF040298 15370001
         BITON (2,7)              Routing codes                PF040398 15380001
         BITON (6)                Descriptor codes             PF040398 15390001
M11X     EQU   *                  Message                      PF040398 15400001
         DC    AL2(M11L-6)        Length of text               PF033198 15410002
         DC    C'LBD321I '                                     PF040398 15420002
M11WTRN  DC    C'wwwwwwww'                                     PF033198 15430000
         DC    C' Writer is active'                            PF033198 15440003
M11L     EQU   *-M11                                           PF033198 15450002
                                                                        15460003
M12      DS    0H                                              PF040698 15470003
         BITON (2,7)              Routing codes                PF040698 15480003
         BITON (6)                Descriptor codes             PF040698 15490003
M12X     EQU   *                  Message                      PF040698 15500003
         DC    AL2(M12L-6)        Length of text               PF043698 15510003
         DC    C'LBD322I '                                     PF040698 15520003
M12WTRN  DC    C'wwwwwwww'                                     PF040698 15530003
         DC    C' AFP2PCL version: '                           PF040698 15540003
M12VERS  DC    CL18' '                                         PF040698 15550003
M12L     EQU   *-M12                                           PF040698 15560003
                                                                        15570004
M14      DS    0H                                              PF980406 15580004
         BITON (7)                Routing codes                PF980406 15590004
         BITON (6)                Descriptor codes             PF980406 15600004
M14X     EQU   *                  Message                      PF980406 15610004
         DC    AL2(M14L-6)        Length of text               PF980406 15620004
         DC    C'LBD323I '                                     PF980406 15630004
M14WTRN  DC    C'wwwwwwww'                                     PF980406 15640004
         DC    C' Fontset '                                    PF980406 15650004
M14FS    DC    C'xx'              Fontset id                   PF980406 15660004
         DC    C' downloaded to '                              PF980406 15670004
M14DEST  DC    CL8'        '      Printer id                   PF041116 15680046
M14L     EQU   *-M14                                           PF980406 15690004
*                                                                       15700000
         EJECT                                                          15710000
* ------------------------------- *                                     15720000
*        SVC99 Parameter lists    *                                     15730000
* ------------------------------- *                                     15740000
S99LISTD DS    0F                  Skeleton DYNALLOC text units         15750000
S99L1    EQU   *                     Allocate input dataset             15760000
         DC    AL4(S99TU11-S99LISTD) Text unit offsets in list          15770000
         DC    AL4(S99TU12-S99LISTD)          .                         15780000
         DC    AL4(S99TU13-S99LISTD+X'80000000')                        15790000
*                                                                       15800000
S99L2    EQU   *                     Unallocate input dataset           15810000
         DC    AL4(S99TU21-S99LISTD)          .                         15820000
         DC    AL4(S99TU22-S99LISTD+X'80000000')                        15830000
*                                                                       15840000
S99L3    EQU   *                     Allocate output dataset            15850000
         DC    AL4(S99TU31-S99LISTD)          .                         15860000
         DC    AL4(S99TU32-S99LISTD)          .                         15870000
         DC    AL4(S99TU33-S99LISTD)          .                         15880009
S99L3E   DC    AL4(S99TU34-S99LISTD+X'80000000')               PF981026 15890009
         DC    AL4(S99TU35-S99LISTD+X'80000000') 'OUTDES' (opt)PF981026 15900009
*                                                                       15910000
S99L4    EQU   *                     Unallocate output dataset          15920000
         DC    AL4(S99TU41-S99LISTD)                                    15930000
         DC    AL4(S99TU42-S99LISTD)                           PF000518 15940036
         DC    AL4(S99TU43-S99LISTD+X'80000000')               PF000518 15950036
*                                                                       15960000
S99L5    EQU   *                     Allocate message dataset           15970000
         DC    AL4(S99TU51-S99LISTD)          .                         15980000
         DC    AL4(S99TU52-S99LISTD+X'80000000')                        15990000
*                                                                       16000000
S99L6    EQU   *                     Unallocate message dataset         16010000
         DC    AL4(S99TU61-S99LISTD+X'80000000')                        16020000
*                                                                       16030000
         DC    4X'FF'                End of Address list                16040000
*                                                                       16050000
*        Allocate input dataset                                         16060000
*                                                                       16070000
S99TU11  DC    AL2(DALDSNAM),AL2(1),AL2(44) DSNAME                      16080000
S99DSN1  DC    CL44' '                                                  16090000
S99TU12  DC    AL2(DALSSREQ),AL2(0)         SUBSYS                      16100000
S99TU13  DC    AL2(DALRTDDN),AL2(1),AL2(8)  Returned DDNAME             16110000
S99DDN1  DC    CL8' '                                                   16120000
*                                                                       16130000
*        Unallocate input dataset                                       16140000
*                                                                       16150000
OVDSPK   EQU   X'08'               Override disp - KEEP                 16160000
OVDSPD   EQU   X'04'               Override disp - DELETE               16170000
*                                                                       16180000
S99TU21  DC    AL2(DUNDDNAM),AL2(1),AL2(8)  DDNAME                      16190000
S99DDN2  DC    CL8' '                                                   16200000
S99TU22  DC    AL2(DUNOVDSP),AL2(1),AL2(1)  Override disp               16210000
S99DSP2  DC    AL1(OVDSPD)                                              16220000
*                                                                       16230000
*        Allocate output dataset                                        16240000
*                                                                       16250000
S99TU31  DC    AL2(DALSYSOU),AL2(1),AL2(1)  SYSOUT(class)               16260000
S99CLS3  DC    AL1(DEFPUN)                                              16270000
S99TU32  DC    AL2(DALRTDDN),AL2(1),AL2(8)  Returned DDNAME             16280000
S99DDN3  DC    CL8' '                                                   16290000
S99TU33  DC    AL2(DALSUSER),AL2(1),AL2(8)  DEST=                       16300000
S99DST3  DC    CL8' '                                                   16310000
S99TU34  DC    AL2(DALSFMNO),AL2(1),AL2(4)  Form name (Len=4)  PF981026 16320009
S99FMN3  DC    CL8'STD'                                        PF981026 16330009
S99TU35  DC    AL2(DALOUTPT),AL2(1),AL2(8)  OUTPUT=                     16340009
S99OUT3  DC    CL8' '                                                   16350009
*                                                                       16360000
*        Unallocate output dataset                                      16370000
*                                                                       16380000
S99TU41  DC    AL2(DUNDDNAM),AL2(1),AL2(8)  DDNAME                      16390000
S99DDN4  DC    CL8' '                                                   16400000
S99TU42  DC    AL2(DUNOVSUS),AL2(1),AL2(8)  DEST=                       16410000
S99DST4  DC    CL8' '                                                   16420000
S99TU43  DC    AL2(DUNOVCLS),AL2(1),AL2(1)  CLASS=             PF000518 16430036
S99CLS4  DC    CL1' '                                          PF000518 16440036
*                                                                       16450000
*        Allocate SYSPRINT dataset                                      16460000
*                                                                       16470000
S99TU51  DC    AL2(DALSYSOU),AL2(1),AL2(1)  SYSOUT(X)                   16480000
S99CLS5  DC    C'X'                                                     16490000
S99TU52  DC    AL2(DALRTDDN),AL2(1),AL2(8)  Returned DDNAME             16500000
S99DDN5  DC    CL8' '                                                   16510000
*                                                                       16520000
*        Unallocate SYSPRINT dataset                                    16530000
*                                                                       16540000
S99TU61  DC    AL2(DUNDDNAM),AL2(1),AL2(8)  DDNAME                      16550000
S99DDN6  DC    CL8' '                                                   16560000
*                                                                       16570000
S99LSTDL EQU   *-S99LISTD          Length of initializer                16580000
*                                                                       16590000
         DROP ,                                                         16600000
                                                                        16610000
         TITLE 'PCLWTR1 - LBD External Writer - ESTAE exit'             16620000
*********************************************************************** 16630000
*        ESTAE exit routine                                           * 16640000
*********************************************************************** 16650000
STAERTN  DS    0H                  ESTAE Retry routine                  16660000
         STM   R14,R12,12(R13)     SAVE REGISTERS                       16670000
         LR    R12,R15                                                  16680000
         USING STAERTN,R12                                              16690000
         CH    R0,=H'12'           Q/ DO WE HAVE SDWA?                  16700000
         BE    STAE01              .. NO, CAN'T RETRY                   16710000
         USING SDWA,R1                                                  16720000
         L     R2,SDWAPARM         LOAD A(ESTAI PARM)                   16730000
         SETRP REGS=(14,12),       PERCOLATE ABEND                     X16740000
               DUMP=YES, (NO)                                          X16750000
               RC=0                                                     16760000
STAE01   EQU   *                   NO SDWA FOR RETRY                    16770000
         SR    R15,R15                                                  16780000
         BR    R14                                                      16790000
         LTORG ,                                                        16800000
         DROP  ,                                                        16810000
                                                                        16820000
         TITLE 'PCLWTR1 - LBD External Writer - print routine'          16830000
*---------------------------------*                                     16840000
*  Write record to SYSPRINT       *                                     16850000
*  (user service routine)         *                                     16860000
*---------------------------------*                                     16870000
PRNTRTN  CSECT ,                                                        16880000
         B     PRT001-*(,R15)      Skip over comment                    16890000
         DC    AL1(8),CL8'PRINTRTN'                                     16900000
PRT001   DS    0H                                                       16910000
         SAVE  (14,12)             Save caller's registers              16920000
         LR    R12,R15             Load base registers                  16930000
         USING PRNTRTN,R12              .                               16940000
*        The address of 'WORK' is passed to PL/I in the ENTRY variable  16950000
*        and returned to the called program (me) in R5.                 16960000
         USING WORK,R5             Established by PL/I                  16970000
         LR    R2,R1               Save parm list address               16980000
         LA    R1,IORSAVE          Load Savearea address                16990000
         ST    R1,8(,R13)          Chain saveareas                      17000000
         ST    R13,4(,R1)               .                               17010000
         LR    R13,R1                   .                               17020000
         LR    R1,R2               Restore parm list address            17030000
         L     R1,0(,R1)           Load record locator address          17040000
         L     R0,0(,R1)           Load record address                  17050000
         LA    R1,SYSPRINT         Load DCB address                     17060000
         PUT   (1),(0)             Write the record                     17070000
PRT999   DS    0H                  Exit                                 17080000
         L     R13,4(,R13)         Load Caller's savearea address       17090000
         RETURN (14,12),RC=0       Return to caller                     17100000
                                                                        17110000
         LTORG                                                          17120000
         DROP  ,                                                        17130000
                                                                        17140000
         TITLE 'PCLWTR1 - LBD External Writer - read routine'           17150000
*---------------------------------*                                     17160000
*  Read record from AFPIN         *                                     17170000
*  (user service routine)         *                                     17180000
*---------------------------------*                                     17190000
READRTN  CSECT ,                                                        17200000
         B     RD001-*(,R15)       Skip over comment                    17210000
         DC    AL1(7),CL7'READRTN'                                      17220000
RD001    DS    0H                                                       17230000
         SAVE  (14,12)             Save caller's registers              17240000
         LR    R12,R15             Load base registers                  17250000
         USING READRTN,R12              .                               17260000
*        The address of 'WORK' is passed to PL/I in the ENTRY variable  17270000
*        and returned to the called program (me) in R5.                 17280000
         USING WORK,R5             Established by PL/I                  17290000
         LR    R2,R1               Save parm list address               17300000
         LA    R1,IORSAVE          Load Savearea address                17310000
         ST    R1,8(,R13)          Chain saveareas                      17320000
         ST    R13,4(,R1)               .                               17330000
         LR    R13,R1                   .                               17340000
         LM    R2,R3,0(R2)         Load Parameter addresses             17350000
         LA    R1,AFPIN            Load DCB address                     17360000
         GET   (1)                 Read the record                      17370000
         LH    R15,0(,R1)          Load VRL                             17380000
         SH    R15,=H'4'                                                17390000
         LA    R1,4(,R1)           Skip over VRL                        17400000
         ST    R1,0(,R2)           Save A(record)                       17410000
         B     RD999                                                    17420000
RDEOF    DS    0H                  EOF on AFPIN                         17430000
         LH    R15,=H'-1'          Indicate EOF                         17440000
RD999    DS    0H                  Exit                                 17450000
         ST    R15,0(,R3)          Store record length or EOF           17460000
         L     R13,4(,R13)         Load Caller's savearea address       17470000
         RETURN (14,12),RC=0       Return to caller                     17480000
                                                                        17490000
         LTORG                                                          17500000
         DROP  ,                                                        17510000
                                                                        17520000
         TITLE 'PCLWTR1 - LBD External Writer - print routine'          17530000
*--------------------------------------*                                17540009
*  Write record to PCLOUT or METAOUT   *                                17550009
*  (user service routine)              *                                17560009
*--------------------------------------*                                17570009
PNCHRTN  CSECT ,                                                        17580000
         ENTRY METARTN                                         PF981026 17590009
METARTN  DS    0H                  Reuse routine for meta      PF981026 17600009
         B     PCH001-*(,R15)      Skip over comment                    17610000
         DC    AL1(8),CL8'PUNCHRTN'                                     17620000
PCH001   DS    0H                                                       17630000
         SAVE  (14,12)             Save caller's registers              17640000
         LR    R12,R15             Load base registers                  17650000
         USING PNCHRTN,R12              .                               17660000
*        The address of 'WORK' is passed to PL/I in the ENTRY variable  17670000
*        and returned to the called program (me) in R5.                 17680000
         USING WORK,R5             Established by PL/I                  17690000
         LR    R2,R1               Save parm list address               17700000
         LA    R1,IORSAVE          Load Savearea address                17710000
         ST    R1,8(,R13)          Chain saveareas                      17720000
         ST    R13,4(,R1)               .                               17730000
         LR    R13,R1                   .                               17740000
         L     R15,0(,R2)          Load A(pointer)                      17750000
         L     R0,0(,R15)          Load pointer                         17760000
         LA    R1,PCLOUT           Load DCB address                     17770000
         PUT   (1),(0)             Write the record                     17780000
PCH999   DS    0H                  Exit                                 17790000
         L     R13,4(,R13)         Load Caller's savearea address       17800000
         RETURN (14,12),RC=0       Return to caller                     17810000
                                                                        17820000
         LTORG                                                          17830000
         DROP  ,                                                        17840000
                                                                        17850000
         TITLE 'PCLWTR1 - LBD External Writer - font routine'           17860000
*---------------------------------*                                     17870000
*  Read data from FONTLIB         *                                     17880000
*  (user service routine)         *                                     17890000
*---------------------------------*                                     17900000
FONTRTN  CSECT ,                                                        17910000
         B     FNT001-*(,R15)      Skip over comment                    17920000
         DC    AL1(8),CL8'FONTRTN'                                      17930000
FNT001   DS    0H                                                       17940000
         SAVE  (14,12)             Save caller's registers              17950000
         LR    R12,R15             Load base registers                  17960000
         USING FONTRTN,R12              .                               17970000
*        The address of 'WORK' is passed to PL/I in the ENTRY variable  17980000
*        and returned to the called program (me) in R5.                 17990000
         LR    R11,R5              Load A(Worakrea)                     18000000
         USING WORK,R11            . Established by PL/I                18010000
         LR    R2,R1               Save parm list address               18020000
         LA    R1,IORSAVE          Load Savearea address                18030000
         ST    R1,8(,R13)          Chain saveareas                      18040000
         ST    R13,4(,R1)               .                               18050000
         LR    R13,R1                   .                               18060000
         LR    R1,R2               Restore parm list address            18070000
         LM    R8,R10,0(R1)        Load parameter addresses             18080000
*                                  A(function_code locator)             18090000
*                                  A(font_name locator/record address)  18100000
*                                  A(return_code)                       18110000
         L     R8,0(,R8)           . A(function_code)                   18120000
         CLI   0(R8),C'F'          Q/ Is this a 'FIND' operation?       18130000
         BE    FNTFIND             .. yes                               18140000
         CLI   0(R8),C'R'          Q/ Is this a 'READ' operation?       18150000
         BE    FNTREAD             .. yes                               18160000
         B     FNTEOF              .. no, error                         18170000
FNTFIND  EQU   *                   Locate the member                    18180000
         L     R9,0(,R9)           . A(Font_name)                       18190000
         MVC   BLDLFFLL(4),=AL2(1,BLDLENTL) Build list                  18200000
         XC    BLDLENT(BLDLENTL),BLDLENT    .                           18210000
         MVC   BLDLNAME,0(R9)               .                           18220000
         LA    R1,FONTLIB          Find the member                      18230000
         LA    R0,BLDLLIST         .                                    18240000
         BLDL  (1),(0)             .                                    18250000
         LTR   R15,R15             Test return code                     18260000
         BNZ   FNTEOF              .. Error                             18270000
         LA    R1,FONTLIB          Find the member                      18280000
         LA    R0,BLDLTTR          Load TTR address                     18290000
         FIND  (1),(0),C           Find the member                      18300000
         LTR   R15,R15             Test return code                     18310000
         BNZ   FNTEOF              .. error                             18320000
         OI    STATUS,ST_FTOK      Indicate successful FIND             18330000
         MVC   FNTDECB,FNTDECBD    Build DECB                           18340000
         L     R1,FNTBUFE          Reset buffer pointer                 18350000
         ST    R1,FNTBUFP          .                                    18360000
         B     FNT999              Return to caller                     18370000
FNTREAD  EQU   *                   Read a record                        18380000
         TM    STATUS,ST_FTOK      Q/ Do we have member to read?        18390000
         BNO   FNTEOF              .. no, error                         18400000
         L     R8,FNTBUFP          Load buffer pointer                  18410000
         C     R8,FNTBUFE          Q/ End of buffer?                    18420000
         BL    FNTREAD1            .. no                                18430000
         LA    R4,FNTDECB          Load DECB address                    18440000
         LA    R5,FONTLIB          Load DCB address                     18450000
         L     R6,FNTBUF           Load buffer address                  18460000
         READ  (R4),SF,(R5),(R6),MF=E  Read a block                     18470000
         CHECK (R4)                Check completion                     18480000
         L     R1,FNTDECB+16       Compute block length (get A(IOB))    18490000
         LH    R1,14(,R1)          . Get residual count from IOB        18500000
         LH    R0,DCBBLKSI-IHADCB+FONTLIB . Get BLKSIZE                 18510000
         SR    R0,R1               . Subtract residual count from BLKSZ 18520000
         A     R0,FNTBUF           Add buffer start address             18530000
         ST    R0,FNTBUFE          Save new end-of-buffer address       18540000
         L     R8,FNTBUF           Reset buffer pointer                 18550000
FNTREAD1 EQU   *                   Deblock record                       18560000
         ST    R8,0(,R9)           Pass back address of this record     18570000
         AH    R8,DCBLRECL-IHADCB+FONTLIB point to next record          18580000
         ST    R8,FNTBUFP          Store updated pointer                18590000
         SR    R15,R15             Set return code                      18600000
         B     FNT999              Return to caller                     18610000
FNTEOF   DS    0H                  EOF on FONTLIB                       18620000
         NI    STATUS,255-ST_FTOK  Indicate no member in progress       18630000
         LH    R15,=H'-1'          .. set error return                  18640000
FNT999   DS    0H                  Exit                                 18650000
         ST    R15,0(,R10)         Save return code                     18660000
         L     R13,4(,R13)         Load Caller's savearea address       18670000
         RETURN (14,12),RC=0       Return to caller                     18680000
                                                                        18690000
         PRINT GEN                                                      18700000
FNTRDD   DS    0H                  Dummy READ DECB                      18710000
         READ  FNTDECBD,SF,MF=L    Generate Read DECB                   18720000
FNTDECBL EQU   *-FNTDECBD                                               18730000
         PRINT NOGEN                                                    18740000
                                                                        18750000
         LTORG                                                          18760000
         DROP  ,                                                        18770000
                                                                        18780000
         TITLE 'PCLWTR1 - LBD External Writer - printer lookup'         18790000
*---------------------------------*                                     18800000
*  Lookup Printer Infornation     *                                     18810000
*  (user service routine)         *                                     18820000
*---------------------------------*                                     18830000
LOOKUP   CSECT ,                                                        18840000
         B     LOK001-*(,R15)      Skip over comment                    18850000
         DC    AL1(6),CL6'LOOKUP'                                       18860000
LOK001   DS    0H                                                       18870000
         SAVE  (14,12)             Save caller's registers              18880000
         LR    R12,R15             Load base registers                  18890000
         USING LOOKUP,R12               .                               18900000
*        The address of 'WORK' is passed to PL/I in the ENTRY variable  18910000
*        and returned to the called program (me) in R5.                 18920000
         LR    R11,R5              Load A(Worakrea)                     18930000
         USING WORK,R11            . Established by PL/I                18940000
         USING AFP2PCL_PARM,A2P_PARM    .                               18950000
         SR    R0,R0                                                    18960000
         ST    R0,A2P_PRTT         Zero printer address                 18970000
         LR    R2,R1               Save parm list address               18980000
         LA    R1,IORSAVE          Load Savearea address                18990000
         ST    R1,8(,R13)          Chain saveareas                      19000000
         ST    R13,4(,R1)               .                               19010000
         LR    R13,R1                   .                               19020000
         LR    R1,R2               Restore parm list address            19030000
         L     R1,0(R1)            Load a(printer id locator)           19040000
         L     R8,0(,R1)           . A(printer id)             PF981028 19050012
                                                                        19060000
*---------------------------------*                                     19070000
*  Find printer token             *                                     19080000
*---------------------------------*                                     19090000
         CLC   =CL8'LOCAL',0(R8)  Q/ Is this 'LOCAL'?          PF981028 19100012
         BE    LOK015             Yes, bypass token routine    PF981026 19110010
         CLC   =CL8'U93  ',0(R8)  Q/ Is this 'X4135'?          PF001127 19120039
         BE    LOK015             Yes, bypass token routine    PF001127 19130038
         MVC   PRNAME(6),=CL6'JES2_ ' Build token name                  19140000
         MVC   PRNAME+6(L'PRNAME-6),PRNAME+5                            19150000
         MVC   PRNAME+5(8),0(R8)      .                        PF981028 19160012
         LA    R1,=F'4'            System level                         19170000
         ST    R1,PARMLIST         .                                    19180000
         LA    R1,PRNAME           Token name                           19190000
         ST    R1,PARMLIST+4       .                                    19200000
         LA    R1,PRTOKEN          Returned - token value               19210000
         ST    R1,PARMLIST+8       .                                    19220000
         LA    R1,RC               Returned - return code               19230000
         ST    R1,PARMLIST+12      .                                    19240000
         LA    R1,PARMLIST         Load parm list address               19250000
         L     R15,=V(IEANTRT)     Load A(name/token routine)           19260000
         BALR  R14,R15             Call IEANTRT                         19270000
         LTR   R15,R15             Test return code                     19280000
         BNZ   LOK990              Request unsuccessful                 19290000
         L     R10,PRTOKEN         Load token address                   19300000
         USING NTCS,R10                                                 19310000
         TM    NTFLAGS,$PCL        Q/ A PCL printer?                    19320000
         BO    LOK010              .. yes                               19330000
         TM    NTFLAGS,$MCK        Q/ Switchable?                       19340000
         BNO   LOK990              .. no, not PCL capable               19350000
                                                                        19360000
***********************************                                     19370000
*  ENQ printer and re-read token  *                                     19380000
***********************************                                     19390000
LOK010   EQU   *                   Extract token info                   19400000
         MVC   DEST,NTPRIME        Save printer ID             PF041116 19410046
         MVC   PRNAME+5(8),0(R8)    .                          PF981028 19420012
         MVC   MACAREA(ENQDL),ENQD ENQ the printer                      19430000
         LR    R2,R8                .                          PF981028 19440012
         LA    R1,MACAREA           .                                   19450000
         ENQ   (,(R2),E),MF=(E,(1)) .                                   19460000
         OI    STATUS,ST_ENQ       Indicate ENQ'd                       19470000
                                                                        19480000
         LA    R1,PARMLIST         Load parm list address               19490000
         L     R15,=V(IEANTRT)     Load A(name/token routine)           19500000
         BALR  R14,R15             Call IEANTRT                         19510000
         LTR   R15,R15             Test return code                     19520000
         BNZ   LOK900              Request unsuccessful                 19530000
         L     R10,PRTOKEN                                              19540000
         TM    NTFLAGS,$PCL        Q/ A PCL printer?                    19550000
         BO    LOK015              .. yes                               19560000
         TM    NTFLAGS,$MCK        Q/ Switchable?                       19570000
         BNO   LOK900              .. no, not PCL capable               19580000
                                                                        19590000
*---------------------------------*                                     19600000
*  Lookup printer table entry     *                                     19610000
*---------------------------------*                                     19620000
LOK015   EQU   *                                                        19630000
         LA    R9,PRINTER_TABLE    Load A(printer table)                19640000
         USING PRINTER,R9                                               19650000
LOK020   EQU   *                                                        19660000
         LR    R2,R9               Save where we're coming from         19670000
         L     R9,PRLINK           Point to next entry                  19680000
         LTR   R9,R9               Q/ End of table?                     19690000
         BZ    LOK030              .. Yes, printer not found            19700000
         CLC   PRID,0(R8)          Q/ is this the printer?     PF981028 19710012
         BNE   LOK020              .. no, try next                      19720000
         B     LOK050              .. yes, update                       19730000
                                                                        19740000
*------------------------------------------------*                      19750000
*  Create new Printer table entry                *                      19760000
*  (ENQ guarantees we won't try to create the    *                      19770000
*   same printer twice in different subtasks.)   *                      19780004
*------------------------------------------------*                      19790000
LOK030   EQU   *                   Create new printer table entry       19800000
         STORAGE OBTAIN,LENGTH=PRLEN,LOC=ANY Get storage                19810000
         LR    R9,R1               Point to new printer                 19820000
         XC    PRINTER(PRLEN),PRINTER Clear the storage                 19830000
         MVC   PRID,0(R8)          Move printer id             PF981028 19840012
                                                                        19850004
LOK040   EQU   *                   Link entry onto chain                19860000
         SR    R0,R0               Link=0 if end-of-chain               19870000
         CS    R0,R9,PRLINK-PRINTER(R2) Update link                     19880000
         BZ    LOK050              OK -- link updated                   19890000
         LR    R2,R0               Else point to new end-of-chain       19900000
         B     LOK040              . and try update again               19910000
                                                                        19920000
*---------------------------------*                                     19930000
*  Update printer from token      *                                     19940000
*---------------------------------*                                     19950000
LOK050   EQU   *                   Update printer data from token       19960000
         CLC   =CL8'LOCAL',0(R8)  Q/ Is this 'LOCAL'?          PF981028 19970012
         BE    LOK055             Yes, bypass token routine    PF981026 19980010
         CLC   =CL8'U93  ',0(R8)  Q/ Is this 'X4135'?          PF001127 19990039
         BE    LOK055             Yes, bypass token routine    PF001127 20000038
         MVC   PRDEVT,NTDEVT       .                                    20010000
         MVC   PRFLAGS,NTFLAGS     .                                    20020000
         MVC   PRMODEL,NTMODEL     .                                    20030000
         MVC   PRTRAY,NTTRAY       .                                    20040000
         MVC   PRFSET,NTFONTS      .                                    20050000
         CLI   PRTRAY,X'00'        Q/ Default tray=x'00'?               20060000
         BNE   *+8                 .. no                                20070000
         MVI   PRTRAY,C'1'         .. yes, name it '1'                  20080000
                                                                        20090004
*---------------------------------*                            PF980406 20100004
*  Update printer fonts           *                            PF980406 20110004
*---------------------------------*                            PF980406 20120004
         LA    R1,FTABLE           Load font table address     PF990120 20130013
LOK051   EQU   *                   Font table lookup           PF990120 20140013
         CLC   PRFSET,0(R1)        Q/ is this the font?        PF990120 20150013
         BE    LOK052              .. yes                      PF990120 20160013
         CLI   0(R1),X'FF'         Q/ end of list?             PF990120 20170015
         BE    LOK052              .. yes                      PF990120 20180013
         LA    R1,6(,R1)           Point to next entry         PF990120 20190013
         B     LOK051              Look at next                PF990120 20200015
LOK052   EQU   *                   Font found                  PF990120 20210013
         L     R1,2(,R1)           Load a(Font table entry)    PF990121 20220015
         LH    R15,0(,R1)          Load number of fonts        PF990120 20230015
         SLL   R15,1               X Length of entry (=2)      PF990120 20240016
         LA    R15,1(,R15)         + two minus one for EX      PF990121 20250015
         EX    R15,MVCF            Move fonts                  PF990120 20260015
*        MVC   PRFCNT(*-*),0(R1)   .                           PF990120 20270015
         TM    NTXPCL,$FONTSET     Q/ Fontset loaded?                   20280015
         BO    LOK055              .. yes, skip                         20290015
         OI    PRFLGF,PRFLGFR      Tell AFP2PCL to download             20300000
                                                                        20310000
*------- Reset download bit in supervisor state, key 0 ----------*    * 20320000
         MODESET KEY=ZERO Enter Supervisor State, Key 0          |    * 20330000
         OI    NTXPCL,$FONTSET     Indicate loaded               |    * 20340000
         MODESET KEY=NZERO Leave Supervisor State                |    * 20350000
*------- End of supervisor state code ---------------------------*    * 20360000
                                                                        20370000
LOK055   EQU   *                                                        20380000
         ST    R9,A2P_PRTT         Success at last!                     20390000
         B     LOK900                                                   20400000
                                                                        20410000
***********************************                                     20420000
*  DEQ the printer                *                                     20430000
***********************************                                     20440000
LOK900   DS    0H                                                       20450000
         TM    STATUS,ST_ENQ       Q/ is printer ENQ'd?                 20460000
         BNO   LOK990              .. no, skip DEQ                      20470000
         MVC   MACAREA(DEQDL),DEQD DEQ the printer                      20480000
         LR    R2,R8                .                          PF981028 20490012
         LA    R1,MACAREA           .                                   20500000
         DEQ   (,(R2),),MF=(E,(1)) .                                    20510000
         NI    STATUS,255-ST_ENQ   Indicate not ENQ'd                   20520000
                                                                        20530000
LOK990   DS    0H                  Exit                                 20540000
         L     R15,A2P_PRTT        address=return code                  20550000
         L     R13,4(,R13)         Load Caller's savearea address       20560000
         RETURN (14,12),RC=(15)    Return to caller                     20570000
                                                                        20580013
*        EXecuted instruction                                  PF990120 20590013
MVCF     MVC   PRFCNT(*-*),0(R1)   .                           PF990120 20600015
         DROP  R9,R10                                                   20610013
                                                                        20620013
*********************************************************************** 20630013
*        Font table list                                      PF990120* 20640013
*********************************************************************** 20650013
FTABLE   DS    0F                  Font table address list    PF990120  20660013
         DC    CL2'00',VL4(FONTST0S)                          PF990120  20670014
         DC    CL2'01',VL4(FONTST1S)                          PF990120  20680014
         DC    CL2'02',VL4(FONTST2S)                          PF990120  20690014
         DC    CL2'03',VL4(FONTST3S)                          PF990120  20700014
         DC    CL2'04',VL4(FONTST4S)                          PF990120  20710014
         DC    XL2'FFFF',VL4(FONTST0S) End of list            PF990120  20720014
                                                                        20730000
ENQD     ENQ   (PRQNAME,*-*,S,L'DEST),RET=USE,MF=L                      20740000
ENQDL    EQU   *-ENQD                                                   20750000
                                                                        20760000
DEQD     DEQ   (PRQNAME,*-*,L'DEST),RET=NONE,MF=L                       20770000
DEQDL    EQU   *-DEQD                                                   20780000
                                                                        20790000
PRQNAME  DC    CL8'PRINTERS'       ENQ Qname                            20800000
                                                                        20810000
         LTORG                                                          20820000
         DROP  ,                                                        20830000
                                                                        20840000
         TITLE 'PCLWTR1 - LBD External Writer - width table routine'    20850000
*---------------------------------*                                     20860000
*  Read data from WIDTAB          *                                     20870000
*  (user service routine)         *                                     20880000
*---------------------------------*                                     20890000
WIDRTN   CSECT ,                                                        20900000
         B     WID001-*(,R15)      Skip over comment                    20910000
         DC    AL1(8),CL8'WIDRTN'                                       20920000
WID001   DS    0H                                                       20930000
         SAVE  (14,12)             Save caller's registers              20940000
         LR    R12,R15             Load base registers                  20950000
         USING WIDRTN,R12               .                               20960000
*        The address of 'WORK' is passed to PL/I in the ENTRY variable  20970000
*        and returned to the called program (me) in R5.                 20980000
         LR    R11,R5              Load A(Worakrea)                     20990000
         USING WORK,R11            . Established by PL/I                21000000
         LR    R2,R1               Save parm list address               21010000
         LA    R1,IORSAVE          Load Savearea address                21020000
         ST    R1,8(,R13)          Chain saveareas                      21030000
         ST    R13,4(,R1)               .                               21040000
         LR    R13,R1                   .                               21050000
         LR    R1,R2               Restore parm list address            21060000
         LM    R8,R10,0(R1)        Load parameter addresses             21070000
*                                  A(function_code locator)             21080000
*                                  A(font_name locator/record pointer)  21090000
*                                  A(return_code)                       21100000
         L     R8,0(,R8)           . A(function_code)                   21110000
         CLI   0(R8),C'F'          Q/ Is this a 'FIND' operation?       21120000
         BE    WIDFIND             .. yes                               21130000
         CLI   0(R8),C'R'          Q/ Is this a 'READ' operation?       21140000
         BE    WIDREAD             .. yes                               21150000
         B     WIDEOF              .. no, error                         21160000
WIDFIND  EQU   *                   Locate the member                    21170000
         L     R9,0(,R9)           . A(Font_name)                       21180000
         MVC   BLDLFFLL(4),=AL2(1,BLDLENTL) Build list                  21190000
         XC    BLDLENT(BLDLENTL),BLDLENT    .                           21200000
         MVC   BLDLNAME,0(R9)               .                           21210000
         LA    R1,WIDTAB           Find the member                      21220000
         LA    R0,BLDLLIST         .                                    21230000
         BLDL  (1),(0)             .                                    21240000
         LTR   R15,R15             Test return code                     21250000
         BNZ   WIDEOF              .. Error                             21260000
         LA    R1,WIDTAB           Find the member                      21270000
         LA    R0,BLDLTTR          Load TTR address                     21280000
         FIND  (1),(0),C           Find the member                      21290000
         LTR   R15,R15             Test return code                     21300000
         BNZ   WIDEOF              .. error                             21310000
         OI    STATUS,ST_FTOK      Indicate successful FIND             21320000
         MVC   WIDDECB,WIDDECBD    Build DECB                           21330000
         L     R1,WIDBUFE          Reset buffer pointer                 21340000
         ST    R1,WIDBUFP          .                                    21350000
         B     WID999              Return to caller                     21360000
WIDREAD  EQU   *                   Read a record                        21370000
         TM    STATUS,ST_FTOK      Q/ Do we have member to read?        21380000
         BNO   WIDEOF              .. no, error                         21390000
         L     R8,WIDBUFP          Load buffer pointer                  21400000
         C     R8,WIDBUFE          Q/ End of buffer?                    21410000
         BL    WIDREAD1            .. no                                21420000
         LA    R4,WIDDECB          Load DECB address                    21430000
         LA    R5,WIDTAB           Load DCB address                     21440000
         L     R6,WIDBUF           Load buffer address                  21450000
         READ  (R4),SF,(R5),(R6),MF=E  Read a block                     21460000
         CHECK (R4)                Check completion                     21470000
         L     R1,WIDDECB+16       Compute block length (get A(IOB))    21480000
         LH    R1,14(,R1)          . Get residual count from IOB        21490000
         LH    R0,DCBBLKSI-IHADCB+WIDTAB . Get BLKSIZE                  21500000
         SR    R0,R1               . Subtract residual count from BLKSZ 21510000
         A     R0,WIDBUF           Add buffer start address             21520000
         ST    R0,WIDBUFE          Save new end-of-buffer address       21530000
         L     R8,WIDBUF           Reset buffer pointer                 21540000
         TM    DCBRECFM-IHADCB+WIDTAB,DCBRECBR Q/ Blocked?              21550000
         BNO   WIDREAD1            .. no                                21560000
         LA    R8,4(,R8)           .. yes, skip over block length       21570000
WIDREAD1 EQU   *                   Deblock record                       21580000
         LA    R1,4(,R8)           Point past VRL                       21590000
         ST    R1,0(,R9)           Pass back address of this record     21600000
         AH    R8,0(,R8)           point to next record                 21610000
         ST    R8,WIDBUFP          Store updated pointer                21620000
         SR    R15,R15             Set return code                      21630000
         B     WID999              Return to caller                     21640000
WIDEOF   DS    0H                  EOF on WIDTAB                        21650000
         NI    STATUS,255-ST_WTOK  Indicate no member in progress       21660000
         LH    R15,=H'-1'          .. set error return                  21670000
WID999   DS    0H                  Exit                                 21680000
         ST    R15,0(,R10)         Save return code                     21690000
         L     R13,4(,R13)         Load Caller's savearea address       21700000
         RETURN (14,12),RC=0       Return to caller                     21710000
                                                                        21720000
         PRINT GEN                                                      21730000
WIDRDD   DS    0H                  Dummy READ DECB                      21740000
         READ  WIDDECBD,SF,MF=L    Generate Read DECB                   21750000
WIDDECBL EQU   *-WIDDECBD                                               21760000
         PRINT NOGEN                                                    21770000
                                                                        21780000
         LTORG                                                          21790000
         DROP  ,                                                        21800000
                                                                        21810000
         TITLE 'PCLWTR1 - LBD External Writer - SEGLIB routine'         21820000
*---------------------------------*                                     21830000
*  Read data from SEGLIB          *                                     21840000
*  (user service routine)         *                                     21850000
*---------------------------------*                                     21860000
SEGRTN   CSECT ,                                                        21870000
         B     SEG001-*(,R15)      Skip over comment                    21880000
         DC    AL1(8),CL8'SEGRTN'                                       21890000
SEG001   DS    0H                                                       21900000
         SAVE  (14,12)             Save caller's registers              21910000
         LR    R12,R15             Load base registers                  21920000
         USING SEGRTN,R12               .                               21930000
*        The address of 'WORK' is passed to PL/I in the ENTRY variable  21940000
*        and returned to the called program (me) in R5.                 21950000
         LR    R11,R5              Load A(Worakrea)                     21960000
         USING WORK,R11            . Established by PL/I                21970000
         LR    R2,R1               Save parm list address               21980000
         LA    R1,IORSAVE          Load Savearea address                21990000
         ST    R1,8(,R13)          Chain saveareas                      22000000
         ST    R13,4(,R1)               .                               22010000
         LR    R13,R1                   .                               22020000
         LR    R1,R2               Restore parm list address            22030000
         LM    R8,R10,0(R1)        Load parameter addresses             22040000
*                                  A(function_code locator)             22050000
*                                  A(font_name locator/record pointer)  22060000
*                                  A(return_code)                       22070000
         L     R8,0(,R8)           . A(function_code)                   22080000
         CLI   0(R8),C'F'          Q/ Is this a 'FIND' operation?       22090000
         BE    SEGFIND             .. yes                               22100000
         CLI   0(R8),C'R'          Q/ Is this a 'READ' operation?       22110000
         BE    SEGREAD             .. yes                               22120000
         B     SEGEOF              .. no, error                         22130000
SEGFIND  EQU   *                   Locate the member                    22140000
         L     R9,0(,R9)           . A(Font_name)                       22150000
         MVC   BLDLFFLL(4),=AL2(1,BLDLENTL) Build list                  22160000
         XC    BLDLENT(BLDLENTL),BLDLENT    .                           22170000
         MVC   BLDLNAME,0(R9)               .                           22180000
         LA    R1,SEGLIB           Find the member                      22190000
         LA    R0,BLDLLIST         .                                    22200000
         BLDL  (1),(0)             .                                    22210000
         LTR   R15,R15             Test return code                     22220000
         BNZ   SEGEOF              .. Error                             22230000
         LA    R1,SEGLIB           Find the member                      22240000
         LA    R0,BLDLTTR          Load TTR address                     22250000
         FIND  (1),(0),C           Find the member                      22260000
         LTR   R15,R15             Test return code                     22270000
         BNZ   SEGEOF              .. error                             22280000
         OI    STATUS,ST_FTOK      Indicate successful FIND             22290000
         MVC   SEGDECB,SEGDECBD    Build DECB                           22300000
         L     R1,SEGBUFE          Reset buffer pointer                 22310000
         ST    R1,SEGBUFP          .                                    22320000
         B     SEG999              Return to caller                     22330000
SEGREAD  EQU   *                   Read a record                        22340000
         TM    STATUS,ST_FTOK      Q/ Do we have member to read?        22350000
         BNO   SEGEOF              .. no, error                         22360000
         L     R8,SEGBUFP          Load buffer pointer                  22370000
         C     R8,SEGBUFE          Q/ End of buffer?                    22380000
         BL    SEGREAD1            .. no                                22390000
         LA    R4,SEGDECB          Load DECB address                    22400000
         LA    R5,SEGLIB           Load DCB address                     22410000
         L     R6,SEGBUF           Load buffer address                  22420000
         READ  (R4),SF,(R5),(R6),MF=E  Read a block                     22430000
         CHECK (R4)                Check completion                     22440000
         L     R1,SEGDECB+16       Compute block length (get A(IOB))    22450000
         LH    R1,14(,R1)          . Get residual count from IOB        22460000
         LH    R0,DCBBLKSI-IHADCB+SEGLIB . Get BLKSIZE                  22470000
         SR    R0,R1               . Subtract residual count from BLKSZ 22480000
         A     R0,SEGBUF           Add buffer start address             22490000
         ST    R0,SEGBUFE          Save new end-of-buffer address       22500000
         L     R8,SEGBUF           Reset buffer pointer                 22510000
         TM    DCBRECFM-IHADCB+SEGLIB,DCBRECBR Q/ Blocked?              22520000
         BNO   SEGREAD1            .. no                                22530000
         LA    R8,4(,R8)           .. yes, skip over block length       22540000
SEGREAD1 EQU   *                   Deblock record                       22550000
         LA    R1,4(,R8)           Point past VRL                       22560000
         ST    R1,0(,R9)           Pass back address of this record     22570000
         AH    R8,0(,R8)           point to next record                 22580000
         ST    R8,SEGBUFP          Store updated pointer                22590000
         SR    R15,R15             Set return code                      22600000
         B     SEG999              Return to caller                     22610000
SEGEOF   DS    0H                  EOF on SEGLIB                        22620000
         NI    STATUS,255-ST_SGOK  Indicate no member in progress       22630000
         LH    R15,=H'-1'          .. set error return                  22640000
SEG999   DS    0H                  Exit                                 22650000
         ST    R15,0(,R10)         Save return code                     22660000
         L     R13,4(,R13)         Load Caller's savearea address       22670000
         RETURN (14,12),RC=0       Return to caller                     22680000
                                                                        22690000
         PRINT GEN                                                      22700000
SEGRDD   DS    0H                  Dummy READ DECB                      22710000
         READ  SEGDECBD,SF,MF=L    Generate Read DECB                   22720000
SEGDECBL EQU   *-SEGDECBD                                               22730000
         PRINT NOGEN                                                    22740000
                                                                        22750000
         LTORG                                                          22760000
         DROP  ,                                                        22770000
                                                                        22780000
         TITLE 'PCLWTR1 - LBD External Writer - Workarea'               22790000
         PRINT  GEN                                                     22800000
         PCLINCL                   Include PCL structures               22810000
                                                                        22820000
*********************************************************************** 22830000
*   Printer default font list                                         * 22840000
*   (Fontset=00)                                               PF980406 22850004
*********************************************************************** 22860000
FONTST0S CSECT ,                   Printer default font list            22870004
         DC     AL2(FONTST0C)      Number of fonts (max 25)             22880004
FONTST0B DS     0H                                                      22890004
         DC     H'152'              1. Titan 10 medium                  22900000
         DC     H'412'              2. Century Schoolbook  9 medium     22910000
         DC     H'413'              3. Century Schoolbook  9 bold       22920000
         DC     H'416'              4. Century Schoolbook 10 medium     22930000
         DC     H'417'              5. Century Schoolbook 10 bold       22940000
         DC     H'424'              6. Century Schoolbook 12 medium     22950000
         DC     H'425'              7. Century Schoolbook 12 bold       22960000
FONTST0E EQU    *                  End of list                          22970004
FONTST0L EQU    *-FONTST0S         Length of list+count                 22980004
FONTST0C EQU    (FONTST0E-FONTST0B)/L'FONTST0B # of fonts (max 25)      22990004
                                                                        23000000
*********************************************************************** 23010000
*   Printer default font list - SJXX                                  * 23020000
*   (Fontset=01)                                               PF980406 23030004
*********************************************************************** 23040000
FONTST1S CSECT  ,                  Printer default font list            23050004
         DC     AL2(FONTST1C)      Number of fonts (max 25)             23060004
FONTST1B DS     0H                                                      23070004
         DC     H'152'              1. Titan 10 medium                  23080000
         DC     H'300'              2. Helvetica  6 medium              23090000
         DC     H'301'              3. Helvetica  6 bold                23100000
         DC     H'304'              4. Helvetica  7 medium              23110000
         DC     H'305'              5. Helvetica  7 bold                23120000
         DC     H'316'              6. Helvetica 10 medium              23130000
         DC     H'317'              7. Helvetica 10 bold                23140000
         DC     H'320'              8. Helvetica 11 medium              23150000
         DC     H'321'              9. Helvetica 11 bold                23160000
         DC     H'412'             10. Century Schoolbook  9 medium     23170000
         DC     H'413'             11. Century Schoolbook  9 bold       23180000
         DC     H'416'             12. Century Schoolbook 10 medium     23190000
         DC     H'417'             13. Century Schoolbook 10 bold       23200000
         DC     H'424'             14. Century Schoolbook 12 medium     23210000
         DC     H'425'             15. Century Schoolbook 12 bold       23220000
         DC     H'428'             16. Century Schoolbook 14 medium     23230000
         DC     H'429'             17. Century Schoolbook 14 bold       23240000
         DC     H'433'             18. Century Schoolbook 18 bold       23250000
         DC     H'437'             19. Century Schoolbook 24 bold       23260000
FONTST1E EQU    *                  End of list                          23270004
FONTST1L EQU    *-FONTST1S         Length of list+count                 23280004
FONTST1C EQU    (FONTST1E-FONTST1B)/L'FONTST1B # of fonts (max 25)      23290004
                                                                        23300000
*********************************************************************** 23310000
*   Printer default font list - SJ16                                  * 23320000
*   (Fontset=02)                                               PF980406 23330004
*********************************************************************** 23340000
FONTST2S CSECT  ,                  Printer default font list            23350004
         DC     AL2(FONTST2C)      Number of fonts (max 25)             23360004
FONTST2B DS     0H                                                      23370004
         DC     H'152'              1. Titan 10 medium                  23380000
         DC     H'412'              2. Century Schoolbook  9 medium     23390000
         DC     H'413'              3. Century Schoolbook  9 bold       23400000
         DC     H'416'              4. Century Schoolbook 10 medium     23410000
         DC     H'417'              5. Century Schoolbook 10 bold       23420000
         DC     H'424'              6. Century Schoolbook 12 medium     23430000
         DC     H'425'              7. Century Schoolbook 12 bold       23440000
         DC     H'428'              8. Century Schoolbook 14 medium     23450000
         DC     H'429'              9. Century Schoolbook 14 bold       23460000
         DC     H'437'             10. Century Schoolbook 24 bold       23470000
FONTST2E EQU    *                  End of list                          23480004
FONTST2L EQU    *-FONTST2S         Length of list+count                 23490004
FONTST2C EQU    (FONTST2E-FONTST2B)/L'FONTST2B # of fonts (max 25)      23500004
                                                                        23510013
*********************************************************************** 23520013
*   Printer default font liST - AJ12, AJXX                            * 23530013
*   (Fontset=03)                                               PF990120 23540013
*********************************************************************** 23550013
FONTST3S CSECT  ,                  Printer default font list            23560013
         DC     AL2(FONTST3C)      Number of fonts (max 25)             23570013
FONTST3B DS     0H                                                      23580013
         DC     H'152'              1. Titan 10 medium ('TTN12M')       23590025
         DC     H'153'              2. Titan 10 bold   ('TTN12B')       23600025
         DC     H'412'              3. Century Schoolbook  9 medium     23610013
         DC     H'413'              4. Century Schoolbook  9 bold       23620013
         DC     H'414'              5. Century Schoolbook  9 italic     23630013
         DC     H'416'              6. Century Schoolbook 10 medium     23640013
         DC     H'418'              7. Century Schoolbook 10 italic     23650013
         DC     H'419'              8. Century Schoolbook 10 bold ital  23660013
         DC     H'424'              9. Century Schoolbook 12 medium     23670013
         DC     H'425'             10. Century Schoolbook 12 bold       23680013
         DC     H'433'             11. Century Schoolbook 18 bold       23690013
         DC     H'320'             12. Helvetica 11 medium              23700013
         DC     H'321'             13. Helvetica 11 bold                23710013
         DC     H'322'             14. Helvetica 11 italic              23720013
FONTST3E EQU    *                  End of list                          23730013
FONTST3L EQU    *-FONTST3S         Length of list+count                 23740013
FONTST3C EQU    (FONTST3E-FONTST3B)/L'FONTST3B # of fonts (max 25)      23750013
                                                                        23760013
*********************************************************************** 23770013
*   Assembly default font list                                        * 23780013
*   (Fontset=04)                                               PF990120 23790013
*********************************************************************** 23800013
FONTST4S CSECT ,                   Printer default font list            23810013
         DC     AL2(FONTST4C)      Number of fonts (max 25)             23820013
FONTST4B DS     0H                                                      23830013
         DC     H'152'              2. Titan 10 medium ('TTN12M')       23840025
         DC     H'153'              3. Titan 10 bold   ('TTN12B')       23850025
         DC     H'156'              1. Titan 12 medium ('TTN10M')       23860025
         DC     H'412'              4. Century Schoolbook  9 medium     23870013
         DC     H'413'              5. Century Schoolbook  9 bold       23880013
         DC     H'416'              6. Century Schoolbook 10 medium     23890013
         DC     H'417'              7. Century Schoolbook 10 bold       23900013
         DC     H'424'              8. Century Schoolbook 12 medium     23910013
         DC     H'425'              9. Century Schoolbook 12 bold       23920013
FONTST4E EQU    *                  End of list                          23930013
FONTST4L EQU    *-FONTST4S         Length of list+count                 23940013
FONTST4C EQU    (FONTST4E-FONTST4B)/L'FONTST4B # of fonts (max 25)      23950013
                                                                        23960013
        $XCTOKEN NTCS=YES                                               23970000
NTCSDL   EQU    *-NTCS             Length of token DSECT                23980000
         PRINT  NOGEN                                                   23990000
         EJECT                                                          24000000
*---------------------------------*                                     24010000
*  Task workarea                  *                                     24020000
*---------------------------------*                                     24030000
WORK     DSECT ,                   Workarea                             24040000
SAVEAREA DS    9D                  OS savearea                          24050000
COMMENT  DS    CL8                 Memory comment                       24060000
IORSAVE  DS    9D                  Savearea for I/O routines            24070000
DWD      DS    D                   Doubleword work area                 24080000
WTRNAME  DS    CL8                 Writer name                 PF021098 24090003
XVERS    DS    CL18                AFP2PCL Version info        PF100697 24100003
WAITLIST DS    2F                  Task wait list                       24110000
PRINTER_TABLE  DS  A               A(Printer table)                     24120000
PARMLIST DS    8A                  Parm list for calls                  24130000
                                                                        24140000
         DS    0D                  Doubleword for entry point           24150000
AFP2PCLA DS    A                   . A(AFP2PCL)                         24160000
         DS    F                   . Zeros                              24170000
                                                                        24180000
PIPIADDR DS    A                   A(CEEPIPI)                           24190000
TOKEN    DS    F                   PIPI token                           24200000
RC       DS    F                   LE Return code                       24210000
REAS     DS    F                   LE Reason code                       24220000
FDBK     DS    F                   LE Feedback code                     24230000
RTOPT    DS    CL255               Run-time options                     24240000
*                                                                       24250000
STATUS   DS    BL1                 Status Byte 0 - misc                 24260006
ST_ENQ   EQU   X'80'               1... .... Printer resource ENQ'd     24270000
ST_WTOK  EQU   X'20'               ..1. .... FIND succesful on WIDTAB   24280000
ST_WTBFF EQU   X'10'               ...1 .... WIDTAB buffer allocated    24290000
ST_SGOK  EQU   X'08'               .... 1... FIND succesful on PF980311 24300006
ST_SGBFF EQU   X'04'               .... .1.. SEGLIB buffer alloPF980311 24310006
ST_FTOK  EQU   X'02'               .... ..1. FIND succesful on FONTLIB  24320000
ST_FTBFF EQU   X'01'               .... ...1 FONTLIB buffer allocated   24330000
                                                                        24340006
STATUS1  DS    BL2                 Status Bytes 1 (two bytes)           24350000
*      STATUS1 - BYTE 0 - dataset status                                24360006
ST_MSALC EQU   X'80'               1... .... Message D/S allocated      24370000
ST_FTALC EQU   X'40'               .1.. .... Fontlib D/S allocated      24380000
ST_INALC EQU   X'20'               ..1. .... Input D/S allocated        24390000
ST_OTALC EQU   X'10'               ...1 .... Output D/S allocated       24400000
ST_MSOPN EQU   X'08'               .... 1... Message D/S open           24410000
ST_FTOPN EQU   X'04'               .... .1.. Fontlib D/S open           24420000
ST_INOPN EQU   X'02'               .... ..1. Input D/S open             24430000
ST_OTOPN EQU   X'01'               .... ...1 Output D/S open m          24440000
*      STATUS1 - BYTE 1 - dataset status (cont)                         24450006
ST_WTOPN EQU   X'80'               1... .... Width table opened         24460000
ST_SGOPN EQU   X'40'               1... .... SEGLIB opened     PF980311 24470000
                                                                        24480006
STATUS2  DS    BL1                 Status Byte 2 - job status           24490006
ST_LINE  EQU   X'80'               1... .... Line mode data             24500000
ST_PS    EQU   X'40'               .1.. .... PostScript data            24510000
ST_META  EQU   X'20'               ..1. .... Metacode data     PF981026 24520008
                                                                        24530006
STATUS3  DS    BL1                 Status Byte 3 - misc                 24540006
ST_OA    EQU   X'80'               1... .... 'OUTADD' done     PF020598 24550000
ST_TEST  EQU   X'40'               .1.. .... This is test wtr  PF980407 24560006
                                                                        24570000
         DS    0F                  Alignment                            24580000
PRNAME   DS    CL16                Peinter token name                   24590000
PRTOKEN  DS    XL16                Name/token workarea                  24600000
                                                                        24610000
OLDJOBI  DS    CL8                 Job ID                               24620000
DEST     DS    CL8                 Job destination                      24630000
PRTDD    DS    CL8                 SYSPRINT DDname                      24640000
JOBID_SAVE DS  CL20                Formatted 'jobname(jobid), '         24650000
         DS    0F                  Alignment                            24660000
SYSPRINT DS    XL(SYSPRTDL)        SYSPRINT DCB                         24670000
AFPIN    DS    XL(AFPINDL)         AFPIN DCB                            24680000
PCLOUT   DS    XL(PCLOUTDL)        PCLOUT/METAOUT DCB          PF981026 24690008
                                                                        24700000
FONTLIB  DS    XL(FONTLBDL)        FONTLIB DCB                          24710000
FNTDECB  DS    XL(FNTDECBL)        FONTLIB DECB                         24720000
FNTBUF   DS    A                   FONTLIB buffer address               24730000
FNTBUFP  DS    A                   FONTLIB current buffer pointer       24740000
FNTBUFE  DS    A                   FONTLIB buffer end address           24750000
FNTBUFL  DS    F                   FONTLIB buffer length                24760000
                                                                        24770000
WIDTAB   DS    XL(WIDTABDL)        WIDTAB DCB                           24780000
WIDDECB  DS    XL(WIDDECBL)        WIDTAB DECB                          24790000
WIDBUF   DS    A                   WIDTAB buffer address                24800000
WIDBUFP  DS    A                   WIDTAB current buffer pointer        24810000
WIDBUFE  DS    A                   WIDTAB buffer end address            24820000
WIDBUFL  DS    F                   WIDTAB buffer length                 24830000
                                                                        24840000
SEGLIB   DS    XL(SEGLIBDL)        SEGLIB DCB                  PF980311 24850000
SEGDECB  DS    XL(SEGDECBL)        SEGLIB DECB                 PF980311 24860000
SEGBUF   DS    A                   SEGLIB buffer address       PF980311 24870000
SEGBUFP  DS    A                   SEGLIB current buffer pointePF980311 24880000
SEGBUFE  DS    A                   SEGLIB buffer end address   PF980311 24890000
SEGBUFL  DS    F                   SEGLIB buffer length        PF980311 24900000
                                                                        24910000
BLDLLIST DS    0F                  FONTLIB/WIDTAB BLDL List             24920000
BLDLFFLL DS    2H                  Count/Length                         24930000
BLDLENT  EQU   *                                                        24940000
BLDLNAME DS    CL8                 Member name                          24950000
BLDLTTR  DS    XL3                 TTR                                  24960000
BLDLK    DS    X                   Concatenation #                      24970000
BLDLZ    DS    X                   Library Type                         24980000
BLDLC    DS    X                   Member type                          24990000
BLDLENTL EQU   *-BLDLENT           Length of entry                      25000000
                                                                        25010000
SSPARM   DS    A                   JES Parmlist                         25020000
MYSSOB   DS    XL(SSOBLEN1)        SSOB storage                         25030000
*                                                                       25040000
         DS    0F                  Alignment                            25050000
SMF6FLAG DS    CL4                 Eyecatcher for SMF record            25060000
SMF6     DS    XL(SMF6END2-SMFRCD6+SMF6DEND-SMF6LN3)                    25070020
*                                                                       25080000
*                                                                       25090000
         DS    0F                  Alignment                            25100000
DYNCMNT  DS    CL8                 Comment                              25110000
S99RBA   DS    A                   A(DYNALLOC Request Block)            25120000
S99RBD   DS    XL(S99RBEND-S99RB)  SVC99 Request block                  25130000
S99T     DS    XL(S99LSTDL)        SVC99 Parameter List                 25140000
                                                                        25150000
COMPTR   DS    A                   A(CPL)                               25160000
                                                                        25170000
STAEPARM DS    F                   ESTAE parameter list                 25180000
                                                                        25190000
MACAREA  DS    0F                  Macro work area                      25200000
         DS    XL(ESTALEN)         Storage for ESTAE macro              25210000
         ORG   MACAREA                                                  25220000
         DS    XL(OPENDL)          Storage for OPEN                     25230000
         ORG   MACAREA                                                  25240000
         DS    XL(ENQDL)           Storage for ENQ                      25250000
         ORG   MACAREA                                                  25260000
         DS    XL(DEQDL)           Storage for DEQ                      25270000
         ORG   MACAREA                                                  25280000
         DS    XL(OUTADDL)         Storage for OUTADD                   25290000
         ORG   MACAREA                                                  25300000
         DS    XL(OUTDELL)         Storage for OUTDEL                   25310000
         ORG   MACAREA                                                  25320000
         DS    XL(WTOSKLL)         Storage for WTO             PF040398 25330002
         ORG   MACAREA                                         PF040398 25340002
         DS    XL(TIMESKLL)        Storage for TIME            PF040698 25350003
         ORG   MACAREA                                         PF040698 25360003
         ORG   ,                   Reset origin                         25370000
                                                                        25380000
MESSAGE  DS    CL120               Print line                  PF100697 25390000
                                                                        25400000
WTOAREA  DS    0F                  WTO work area                        25410000
         DS    XL(EM1L)            Reserve storage for                  25420000
         ORG   WTOAREA               largest WTO                        25430000
         DS    XL(EM2L)              .                                  25440000
         ORG   WTOAREA               .                                  25450000
         DS    XL(EM3L)              .                                  25460000
         ORG   WTOAREA               .                                  25470000
         DS    XL(EM4L)              .                                  25480000
         ORG   WTOAREA               .                                  25490000
         DS    XL(EM5L)              .                                  25500000
         ORG   WTOAREA               .                                  25510000
         DS    XL(EM6L)              .                                  25520000
         ORG   WTOAREA               .                                  25530000
         DS    XL(EM7L)              .                                  25540000
         ORG   WTOAREA               .                                  25550000
         DS    XL(E320L)             .                                  25560038
         ORG   WTOAREA               .                                  25570000
         DS    XL(M8L)               .                                  25580000
         ORG   WTOAREA               .                                  25590000
         DS    XL(M9L)               .                                  25600000
         ORG   WTOAREA               .                                  25610000
         DS    XL(M11L)              .                                  25620000
         ORG   WTOAREA               .                         PF040698 25630003
         DS    XL(M12L)              .                         PF040698 25640003
         ORG   WTOAREA               .                                  25650000
         ORG   ,                   Reset origin                         25660000
                                                                        25670000
AADDR    DS    A                   Yet another level of indirection :-( 25680000
APTR     DS    A                   A(PADDR)                             25690000
PADDR    DS    A                   PTR->PARM                            25700000
                                                                        25710000
A2P_ID   DS    CL8                 Flag for dumps                       25720000
A2P_PARM DS    XL(A2P_L)           AFP2PCL Parms                        25730000
                                                                        25740000
EXLIST   DS    F                   Exit list for RDJFCB                 25750000
JFCB     DS    0F                  Copy JFCB DSECT                      25760000
         IEFJFCBN                                                       25770000
                                                                        25780000
         DS    0D                  Doubleword alignment        PF030498 25790000
WRKLEN   EQU   *-WORK              L'Workarea                           25800000
         SPACE 2                                                        25810000
                                                                        25820000
         TITLE 'PCLWTR1 - LBD External Writer - DSECTS'                 25830000
         PRINT NOGEN                                                    25840000
         CVT   DSECT=YES           Copy CVT DSECT                       25850000
         DCBD  DSORG=PS,DEVD=DA    DCB DSECT                            25860000
         IHAECB ,                  ECB DSECT                            25870000
         IHASDWA                   COPY SDWA DSECT                      25880000
         IEFDOKEY ,                Copy Dyn Out. text unit keys         25890000
         IEFDOTUM ,                Copy Dyn Out. text unit map          25900000
         IEFJESCT                  Copy JES comm table                  25910000
         IEFZB4D0 ,                Copy SVC99 Dsects                    25920000
         IEFZB4D2 ,                Copy SVC99 Text keys                 25930000
         PRINT GEN                                                      25940000
         IEFSSOBH                  Copy SSOB                            25950000
SSOBGN   EQU   *                                                        25960000
         IEFSSSO SOEXT=YES                                              25970000
         EJECT                                                          25980000
SMF6D    DSECT                                                          25990000
         IFASMFR 6                 SMF Type 6 record                    26000000
         END                                                            26010000
//* --------------------------------------------------------------- *** 26020000
//LKED     EXEC PGM=LBDLINK,                                           X26030000
//            PARM='XREF,LET,LIST,NCAL,RENT,REUS,REFR',                X26040000
//            COND=(8,LT,ASM)                                           26050000
//********************************************************************  26060000
//**       LINKEDIT PROGRAM                                          *  26070000
//********************************************************************  26080000
//SYSPRINT DD SYSOUT=X,CHARS=(GT12)                                     26090000
//SYSUT1   DD UNIT=VIO,SPACE=(CYL,(1,1))                                26100000
//SYSLIB   DD DSN=FLASS.PCL.LINKLIB,DISP=SHR                            26110000
//         DD DSN=SYSTEMS.LINKLIB,DISP=SHR                              26120000
//         DD DSN=SYS1.CSSLIB,DISP=SHR                                  26130000
//SYSLMOD  DD DISP=SHR,DSN=SYSTEMS.LINKLIB                              26140044
//*SYSLMOD  DD DISP=SHR,DSN=SYSTEMS.AUTHLIB                             26150044
//SYSLIN   DD DSN=&&ASM,DISP=(OLD,DELETE)                               26160000
//         DD *                                                         26170000
 INCLUDE SYSLIB(IEANTRT)                                                26180000
 INCLUDE SYSLIB(PS)                                                     26190027
 SETCODE AC(1)                                                          26200000
 NAME PCLWTR1(R)                                                        26210000
//* --------------------------------------------------------------- *** 26220000
